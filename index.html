<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω SOP Danh m·ª•c Thu·ªëc Nh·∫≠n H√†ng (B·∫£n M·ªõi - SOP T√¢m)</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #2c5aa0;
            --secondary-color: #e74c3c;
            --accent-color: #27ae60;
            --light-bg: #f8f9fa;
            --border-color: #dee2e6;
            --text-color: #333;
        }
        
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            margin: 0;
            padding: 15px;
            background-color: #f0f2f5;
            color: var(--text-color);
            font-size: 14px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 15px;
        }
        .logo-container {
            width: 120px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .logo {
            max-width: 100%;
            max-height: 100%;
        }
        .company-info {
            flex-grow: 1;
            text-align: center;
            padding: 0 15px;
        }
        .company-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--primary-color);
        }
        .document-title {
            font-size: 20px;
            font-weight: bold;
            margin: 8px 0;
            color: var(--secondary-color);
            text-transform: uppercase;
        }
        .document-code {
            font-size: 14px;
            margin-bottom: 5px;
            color: #6c757d;
        }
        .compact-form-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--light-bg);
        }
        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 10px;
            gap: 10px;
        }
        .form-group {
            flex: 1;
            min-width: 180px;
        }
        .compact-form-group {
            flex: 1;
            min-width: 150px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--primary-color);
            font-size: 13px;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 13px;
            transition: all 0.2s;
        }
        /* CSS ri√™ng cho Textarea t·ª± ƒë·ªông gi√£n d√≤ng */
        textarea.auto-resize {
            width: 100%;
            resize: none; /* T·∫Øt k√©o g√≥c m·∫∑c ƒë·ªãnh */
            overflow: hidden; /* ·∫®n thanh cu·ªôn */
            min-height: 34px; /* Cao b·∫±ng input th∆∞·ªùng */
            font-family: inherit;
            padding: 8px 10px;
            box-sizing: border-box;
            line-height: 1.4;
            background-color: white;
        }
        textarea.auto-resize:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(44, 90, 160, 0.1);
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(44, 90, 160, 0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 13px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            table-layout: fixed; /* Quan tr·ªçng ƒë·ªÉ c·ªôt gi·ªØ k√≠ch th∆∞·ªõc khi k√©o */
        }
        th, td {
            border: 1px solid var(--border-color);
            padding: 8px;
            text-align: center;
            word-wrap: break-word; /* Cho ph√©p xu·ªëng d√≤ng trong √¥ */
        }
        th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            font-size: 12px;
            position: relative; /* ƒê·ªÉ ƒë·ªãnh v·ªã thanh k√©o */
        }
        /* CSS cho thanh k√©o c·ªôt */
        .resizer {
            position: absolute;
            top: 0;
            right: 0;
            width: 5px;
            cursor: col-resize;
            user-select: none;
            height: 100%;
            z-index: 10;
        }
        .resizer:hover, .resizing {
            background-color: var(--secondary-color);
            opacity: 0.7;
        }

        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .action-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
        }
        .utility-buttons {
            margin-top: 10px;
            display: flex;
            justify-content: flex-start;
            gap: 8px;
        }
        button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 5px rgba(0,0,0,0.1);
        }
        .btn-primary { background-color: var(--accent-color); color: white; }
        .btn-primary:hover { background-color: #219653; }
        .btn-secondary { background-color: var(--primary-color); color: white; }
        .btn-secondary:hover { background-color: #1e4a8a; }
        .btn-danger { background-color: #e74c3c; color: white; }
        .btn-danger:hover { background-color: #c0392b; }
        .btn-warning { background-color: #f39c12; color: white; }
        .btn-warning:hover { background-color: #d35400; }
        .btn-info { background-color: #3498db; color: white; }
        .btn-info:hover { background-color: #2980b9; }
        .btn-purple { background-color: #9b59b6; color: white; }
        .btn-purple:hover { background-color: #8e44ad; }
        
        .hidden { display: none; }
        .upload-section {
            margin-top: 20px;
            padding: 15px;
            border: 2px dashed #bdc3c7;
            border-radius: 6px;
            background-color: #f8f9fa;
        }
        .receiving-info {
            margin-top: 15px;
            padding: 12px;
            background-color: #ecf0f1;
            border-radius: 5px;
        }
        .receiving-info-row {
            display: flex;
            margin-bottom: 8px;
            align-items: center;
        }
        .receiving-info-label {
            min-width: 180px;
            font-weight: 600;
            color: var(--primary-color);
            font-size: 13px;
        }
        .receiving-info-input {
            flex-grow: 1;
            padding: 6px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: white;
            font-size: 13px;
        }
        .signature-section {
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
        }
        .signature-box {
            text-align: center;
            width: 200px;
        }
        .signature-line {
            border-top: 1px solid var(--text-color);
            margin-top: 40px;
            padding-top: 5px;
            font-weight: 600;
        }
        .pdf-options {
            margin-top: 15px;
            padding: 12px;
            background-color: #f9f9f9;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }
        .pdf-options label {
            display: inline-block;
            margin-right: 15px;
            font-weight: normal;
        }
        .no-print { display: block; }
        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border-color);
        }
        .saved-files-section {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--light-bg);
        }
        .files-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 10px;
            background-color: white;
        }
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        .file-item:last-child { border-bottom: none; }
        .file-info { flex-grow: 1; }
        .file-name { font-weight: 600; color: var(--primary-color); }
        .file-date { font-size: 12px; color: #6c757d; }
        .file-actions { display: flex; gap: 5px; }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-online { background-color: var(--accent-color); }
        .status-offline { background-color: #e74c3c; }
        
        @media print {
            .no-print, .no-print * { display: none !important; }
            body { padding: 0; background-color: white; }
            .container { box-shadow: none; padding: 10px; max-width: 100%; }
            table { font-size: 12px; }
            th, td { padding: 6px; }
        }
        .alert {
            padding: 10px;
            border-radius: 4px;
            margin: 8px 0;
            font-size: 13px;
        }
        .alert-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        
        .compact-table { font-size: 12px; }
        .compact-table th, .compact-table td { padding: 6px 4px; vertical-align: middle; }
        .compact-table input, .compact-table select { padding: 4px 6px; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container" id="contentToPrint">
        <div class="header">
            <div class="logo-container">
                <img src="https://cdn.imgpile.com/f/ZMtwhK9_xl.png" alt="Logo c√¥ng ty" class="logo">
            </div>
            <div class="company-info">
                <div class="company-name">C√îNG TY TNHH TM DV K·∫æT GIAO PH√ÅT TRI·ªÇN QU·ªêC T·∫æ IDECO</div>
                <div class="document-title">BI√äN B·∫¢N NH·∫¨N H√ÄNG</div>
                <div class="document-code">BMI.06</div>
            </div>
            <div class="logo-container" style="visibility: hidden;">
                </div>
        </div>

        <div id="connectionStatus" class="alert" style="display: none;">
            <span class="status-indicator status-offline"></span>
            <span id="statusText">ƒêang k·∫øt n·ªëi v·ªõi Firebase...</span>
        </div>

        <div class="compact-form-section">
            <div class="section-title">Th√¥ng tin nh·∫≠n h√†ng</div>
            <div class="form-row">
                <div class="compact-form-group">
                    <label for="supplierName">T√™n nh√† cung c·∫•p</label>
                    <input type="text" id="supplierName">
                </div>
                <div class="compact-form-group">
                    <label for="invoiceNumber">H√≥a ƒë∆°n</label>
                    <input type="text" id="invoiceNumber">
                </div>
                <div class="compact-form-group">
                    <label for="contractNumber">S·ªë h·ª£p ƒë·ªìng</label>
                    <input type="text" id="contractNumber">
                </div>
            </div>
            <div class="form-row">
                <div class="compact-form-group">
                    <label for="receivingPlace">N∆°i nh·∫≠n h√†ng</label>
                    <input type="text" id="receivingPlace" value="003 Carlion 5 262/3 L≈©y B√°n B√≠ch - Ph∆∞·ªùng T√¢n Ph√∫ -Tp. H·ªì Ch√≠ Minh">
                </div>
                <div class="compact-form-group">
                    <label for="receivingDate">Ng√†y nh·∫≠n</label>
                    <input type="date" id="receivingDate">
                </div>
                <div class="compact-form-group">
                    <label for="receivingTime">Gi·ªù nh·∫≠n</label>
                    <input type="time" id="receivingTime">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="inspectionResult">K·∫øt qu·∫£ ki·ªÉm nghi·ªám</label>
                    <textarea id="inspectionResult" rows="2"></textarea>
                </div>
            </div>
        </div>

        <div class="compact-form-section">
            <div class="section-title">Danh m·ª•c thu·ªëc nh·∫≠n h√†ng (C√≥ th·ªÉ k√©o ƒë·ªô r·ªông c·ªôt)</div>
            <table id="productTable" class="compact-table">
                <thead>
                    <tr>
                        <th style="width: 40px;">STT</th>
                        <th style="width: 200px;">T√™n h√†ng</th>
                        <th style="width: 80px;">ƒêVT</th>
                        <th style="width: 90px;">S·ªë L√¥</th>
                        <th style="width: 90px;">H·∫°n SD</th>
                        <th style="width: 80px;">SL<br>Th·ª±c t·∫ø</th>
                        <th style="width: 60px;">Th·ª´a</th>
                        <th style="width: 60px;">Thi·∫øu</th>
                        <th style="width: 60px;">H·ªèng</th>
                        <th style="width: 100px;">T√¨nh tr·∫°ng</th>
                        <th style="width: 100px;">Ghi ch√∫</th>
                        <th style="width: 50px;" class="no-print">X√≥a</th>
                    </tr>
                </thead>
                <tbody id="productTableBody">
                    </tbody>
            </table>
            <button type="button" id="addProductBtn" class="btn-secondary no-print" style="margin-top: 10px;">
                <span>+</span> Th√™m s·∫£n ph·∫©m
            </button>
        </div>

        <div class="receiving-info">
            <div class="receiving-info-row">
                <div class="receiving-info-label">Giao nh·∫≠n v·∫≠n chuy·ªÉn:</div>
                <input type="text" class="receiving-info-input" id="deliveryTransport" placeholder="Nh·∫≠p th√¥ng tin giao nh·∫≠n v·∫≠n chuy·ªÉn...">
            </div>
            <div class="receiving-info-row">
                <div class="receiving-info-label">ƒêi·ªÅu ki·ªán thanh to√°n:</div>
                <input type="text" class="receiving-info-input" id="paymentCondition" placeholder="Nh·∫≠p ƒëi·ªÅu ki·ªán thanh to√°n...">
            </div>
            <div class="receiving-info-row">
                <div class="receiving-info-label">C√°c y√™u c·∫ßu kh√°c:</div>
                <input type="text" class="receiving-info-input" id="otherRequirements" placeholder="Nh·∫≠p c√°c y√™u c·∫ßu kh√°c...">
            </div>
        </div>

        <div class="signature-section">
            <div></div> <div class="signature-box">
                <div class="signature-line">Ng∆∞·ªùi l·∫≠p bi√™n b·∫£n</div>
                <input type="text" id="preparerName" placeholder="H·ªç t√™n" style="width: 100%; margin-top: 5px; text-align: center; border: none; border-bottom: 1px dashed #ccc; background: transparent; outline: none;">
            </div>
            <div class="signature-box">
                <div class="signature-line">B·ªô ph·∫≠n Kho</div>
                <input type="text" id="warehouseStaffName" value="Nguy·ªÖn Minh T√¢m" placeholder="H·ªç t√™n" style="width: 100%; margin-top: 5px; text-align: center; border: none; border-bottom: 1px dashed #ccc; background: transparent; outline: none;">
            </div>
        </div>

        <div class="saved-files-section no-print">
            <div class="section-title">Danh s√°ch file PDF ƒë√£ l∆∞u</div>
            <div class="files-list" id="filesList">
                <div class="file-item">
                    <div class="file-info">
                        <div class="file-name">ƒêang t·∫£i danh s√°ch...</div>
                    </div>
                </div>
            </div>
            <p style="font-size: 12px; color: #6c757d; margin-top: 8px;">
                <strong>L∆∞u √Ω:</strong> T·ªëi ƒëa 10 file g·∫ßn nh·∫•t s·∫Ω ƒë∆∞·ª£c l∆∞u tr·ªØ. C√°c file c≈© h∆°n s·∫Ω t·ª± ƒë·ªông b·ªã x√≥a.
            </p>
        </div>

        <div class="upload-section no-print">
            <div class="section-title">Upload d·ªØ li·ªáu t·ª´ Excel</div>
            <div class="form-row">
                <div class="form-group">
                    <label for="dataFile">Ch·ªçn file Excel (.xlsx, .xls)</label>
                    <input type="file" id="dataFile" accept=".xlsx,.xls">
                </div>
            </div>
            <p style="font-size: 13px; margin: 8px 0;"><strong>ƒê·ªãnh d·∫°ng file Excel h·ªó tr·ª£:</strong></p>
            <p style="font-size: 13px; margin: 5px 0;">File c·ªßa b·∫°n c·∫ßn c√≥ c√°c c·ªôt: STT, T√™n H√†ng H√≥a, ƒê∆°n V·ªã, T·ªïng S·ªë L∆∞·ª£ng, S·ªë L√¥, H·∫°n D√πng</p>
            <div id="uploadMessage"></div>
        </div>

        <div class="utility-buttons no-print">
            <button type="button" id="cameraAiBtn" class="btn-purple" onclick="openCameraAI()">
                üì∑ Ch·ª•pAI
            </button>
            <button type="button" id="erpHomeBtn" class="btn-purple" onclick="openERPHome()">
                üè† ERP HOME
            </button>
        </div>

        <div class="action-buttons no-print">
            <button type="button" id="saveBtn" class="btn-primary">
                üíæ L∆∞u & T·∫°o PDF
            </button>
            <button type="button" id="exportExcelBtn" class="btn-info">
                üìä Xu·∫•t Excel
            </button>
            <button type="button" id="exportPdfBtn" class="btn-warning">
                üìÑ Xu·∫•t PDF
            </button>
            <button type="button" id="printBtn" class="btn-secondary">
                üñ®Ô∏è In
            </button>
            <button type="button" id="resetBtn" class="btn-danger">
                üîÑ L√†m m·ªõi
            </button>
        </div>

        <div class="pdf-options no-print" id="pdfOptions" style="display: none;">
            <h4 style="margin-top: 0; font-size: 14px;">T√πy ch·ªçn xu·∫•t PDF:</h4>
            <label>
                <input type="radio" name="pageOrientation" value="portrait" checked> Kh·ªï d·ªçc (A4)
            </label>
            <label>
                <input type="radio" name="pageOrientation" value="landscape"> Kh·ªï ngang (A4)
            </label>
            <button type="button" id="confirmExportPdf" class="btn-primary" style="margin-left: 10px;">X√°c nh·∫≠n xu·∫•t PDF</button>
            <button type="button" id="cancelExportPdf" class="btn-danger" style="margin-left: 5px;">H·ªßy</button>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCM_gZ1DEOtUwB0Ii-dm-6jIpxydoJU4-E",
            authDomain: "dulieuthuoc-d532e.firebaseapp.com",
            projectId: "dulieuthuoc-d532e",
            storageBucket: "dulieuthuoc-d532e.firebasestorage.app",
            messagingSenderId: "70002622120",
            appId: "1:70002622120:web:9676e1616a0774bae28c9d",
            measurementId: "G-LQ5P054T97"
        };

        // Initialize Firebase
        let db, storage;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            storage = firebase.storage();
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
        }

        // --- H√ÄM H·ªñ TR·ª¢ TEXTAREA T·ª∞ CO GI√ÉN ---
        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
        }

        // --- H√ÄM H·ªñ TR·ª¢ K√âO C·ªòT (RESIZABLE COLUMNS) ---
        function makeTableResizable() {
            const table = document.getElementById('productTable');
            const cols = table.querySelectorAll('th');

            cols.forEach((col) => {
                // Ch·ªâ th√™m resizer n·∫øu ch∆∞a c√≥ v√† kh√¥ng ph·∫£i c·ªôt cu·ªëi c√πng (c·ªôt X√≥a)
                if (!col.querySelector('.resizer') && !col.classList.contains('no-print')) {
                    const resizer = document.createElement('div');
                    resizer.classList.add('resizer');
                    col.appendChild(resizer);
                    createResizableColumn(col, resizer);
                }
            });
        }

        function createResizableColumn(col, resizer) {
            let x = 0;
            let w = 0;

            const mouseDownHandler = function (e) {
                x = e.clientX;
                const styles = window.getComputedStyle(col);
                w = parseInt(styles.width, 10);

                document.addEventListener('mousemove', mouseMoveHandler);
                document.addEventListener('mouseup', mouseUpHandler);
                
                resizer.classList.add('resizing');
            };

            const mouseMoveHandler = function (e) {
                const dx = e.clientX - x;
                col.style.width = `${w + dx}px`;
            };

            const mouseUpHandler = function () {
                document.removeEventListener('mousemove', mouseMoveHandler);
                document.removeEventListener('mouseup', mouseUpHandler);
                resizer.classList.remove('resizing');
            };

            resizer.addEventListener('mousedown', mouseDownHandler);
        }

        function openCameraAI() { window.open('https://idecochupanh.netlify.app', '_blank'); }
        function openERPHome() { window.open('https://erp-ideco.skyit.vn/#/app/dashboard/main', '_blank'); }

        document.addEventListener('DOMContentLoaded', function() {
            // K√≠ch ho·∫°t t√≠nh nƒÉng k√©o c·ªôt ngay khi t·∫£i trang
            makeTableResizable();

            const connectionStatus = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            
            if (db) {
                db.enableNetwork().then(() => {
                    connectionStatus.style.display = 'block';
                    connectionStatus.className = 'alert alert-success';
                    statusText.innerHTML = '<span class="status-indicator status-online"></span> ƒê√£ k·∫øt n·ªëi v·ªõi Firebase - D·ªØ li·ªáu realtime';
                }).catch((error) => {
                    connectionStatus.style.display = 'block';
                    connectionStatus.className = 'alert alert-error';
                    statusText.innerHTML = '<span class="status-indicator status-offline"></span> L·ªói k·∫øt n·ªëi Firebase: ' + error.message;
                });
            } else {
                connectionStatus.style.display = 'block';
                connectionStatus.className = 'alert alert-error';
                statusText.innerHTML = '<span class="status-indicator status-offline"></span> Kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi Firebase';
            }

            const addProductBtn = document.getElementById('addProductBtn');
            const productTableBody = document.getElementById('productTableBody');
            const uploadMessage = document.getElementById('uploadMessage');
            let productCount = 0;
            
            loadDataFromFirebase();
            loadSavedFiles();
            
            addProductBtn.addEventListener('click', function() {
                addNewProductRow();
            });
            
            function showMessage(message, type = 'success') {
                uploadMessage.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
                setTimeout(() => {
                    uploadMessage.innerHTML = '';
                }, 5000);
            }
            
            function addNewProductRow(productData = {}) {
                productCount++;
                const newRow = document.createElement('tr');
                
                // L·∫•y t√™n s·∫£n ph·∫©m
                const productNameVal = productData['T√™n H√†ng H√≥a'] || productData['T√™n h√†ng'] || productData['productName'] || '';

                newRow.innerHTML = `
                    <td>${productCount}</td>
                    <td>
                        <textarea name="productName" class="auto-resize" rows="1" oninput="autoResize(this)">${productNameVal}</textarea>
                    </td>
                    <td><input type="text" name="unit" value="${productData['ƒê∆°n V·ªã'] || productData['ƒê∆°n v·ªã t√≠nh'] || productData['unit'] || 'H·ªôp'}"></td>
                    <td><input type="text" name="lotNumber" value="${productData['S·ªë L√¥'] || productData['S·ªë l√¥'] || productData['lotNumber'] || ''}"></td>
                    <td><input type="date" name="expiryDate" value="${formatDateForInput(productData['H·∫°n D√πng'] || productData['H·∫°n s·ª≠ d·ª•ng'] || productData['expiryDate'] || '')}"></td>
                    <td><input type="number" name="actualQuantity" min="0" value="${productData['T·ªïng S·ªë L∆∞·ª£ng'] || productData['S·ªë l∆∞·ª£ng'] || productData['actualQuantity'] || ''}"></td>
                    <td><input type="number" name="excessQuantity" min="0" value="${productData['excessQuantity'] || 0}"></td>
                    <td><input type="number" name="shortageQuantity" min="0" value="${productData['shortageQuantity'] || 0}"></td>
                    <td><input type="number" name="damagedQuantity" min="0" value="${productData['damagedQuantity'] || 0}"></td>
                    <td>
                        <select name="packageCondition">
                            <option value="Nguy√™n ven" ${productData['packageCondition'] == 'Nguy√™n ven' ? 'selected' : ''}>Nguy√™n ven</option>
                            <option value="H∆∞ h·ªèng nh·∫π" ${productData['packageCondition'] == 'H∆∞ h·ªèng nh·∫π' ? 'selected' : ''}>H∆∞ h·ªèng nh·∫π</option>
                            <option value="H∆∞ h·ªèng n·∫∑ng" ${productData['packageCondition'] == 'H∆∞ h·ªèng n·∫∑ng' ? 'selected' : ''}>H∆∞ h·ªèng n·∫∑ng</option>
                        </select>
                    </td>
                    <td><input type="text" name="note" value="${productData['note'] || ''}"></td>
                    <td class="no-print"><button type="button" class="btn-danger remove-product" style="padding: 4px 8px; font-size: 11px;">X√≥a</button></td>
                `;
                
                productTableBody.appendChild(newRow);
                
                // Trigger resize ngay l·∫≠p t·ª©c n·∫øu c√≥ n·ªôi dung
                const txtArea = newRow.querySelector('textarea[name="productName"]');
                if(txtArea.value) autoResize(txtArea);

                newRow.querySelector('.remove-product').addEventListener('click', function() {
                    productTableBody.removeChild(newRow);
                    updateRowNumbers();
                    saveDataToFirebase(); 
                });
            }
            
            function formatDateForInput(dateString) {
                if (!dateString) return '';
                if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) return dateString;
                const parts = dateString.split('/');
                if (parts.length === 3) {
                    const day = parts[0].padStart(2, '0');
                    const month = parts[1].padStart(2, '0');
                    const year = parts[2];
                    return `${year}-${month}-${day}`;
                }
                return dateString;
            }
            
            function updateRowNumbers() {
                const rows = productTableBody.querySelectorAll('tr');
                productCount = 0;
                rows.forEach(row => {
                    productCount++;
                    row.cells[0].textContent = productCount;
                });
            }
            
            function collectFormData() {
                const products = [];
                const rows = productTableBody.querySelectorAll('tr');
                rows.forEach(row => {
                    products.push({
                        productName: row.querySelector('textarea[name="productName"]').value, 
                        unit: row.querySelector('input[name="unit"]').value,
                        lotNumber: row.querySelector('input[name="lotNumber"]').value,
                        expiryDate: row.querySelector('input[name="expiryDate"]').value,
                        actualQuantity: row.querySelector('input[name="actualQuantity"]').value,
                        excessQuantity: row.querySelector('input[name="excessQuantity"]').value,
                        shortageQuantity: row.querySelector('input[name="shortageQuantity"]').value,
                        damagedQuantity: row.querySelector('input[name="damagedQuantity"]').value,
                        packageCondition: row.querySelector('select[name="packageCondition"]').value,
                        note: row.querySelector('input[name="note"]').value
                    });
                });

                return {
                    deliveryInfo: {
                        supplier: document.getElementById('supplierName').value,
                        invoice: document.getElementById('invoiceNumber').value,
                        contract: document.getElementById('contractNumber').value,
                        place: document.getElementById('receivingPlace').value,
                        date: document.getElementById('receivingDate').value,
                        time: document.getElementById('receivingTime').value,
                        inspection: document.getElementById('inspectionResult').value,
                        deliveryTransport: document.getElementById('deliveryTransport').value,
                        paymentCondition: document.getElementById('paymentCondition').value,
                        otherRequirements: document.getElementById('otherRequirements').value,
                        preparerName: document.getElementById('preparerName').value,
                        warehouseStaffName: document.getElementById('warehouseStaffName').value
                    },
                    products: products
                };
            }

            function saveDataToFirebase() {
                if (!db) {
                    showMessage('Kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi Firebase', 'error');
                    return;
                }
                
                const formData = collectFormData();
                
                db.collection('deliveryRecords').doc('current').set(formData)
                    .then(() => {
                        console.log('D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c l∆∞u l√™n Firebase');
                    })
                    .catch((error) => {
                        console.error('L·ªói khi l∆∞u d·ªØ li·ªáu l√™n Firebase:', error);
                        showMessage('L·ªói khi l∆∞u d·ªØ li·ªáu l√™n Firebase', 'error');
                    });
            }
            
            function loadDataFromFirebase() {
                if (!db) return;
                
                db.collection('deliveryRecords').doc('current').onSnapshot((doc) => {
                    if (doc.exists) {
                        const formData = doc.data();
                        populateFormData(formData);
                        showMessage('D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c ƒë·ªìng b·ªô t·ª´ Firebase', 'success');
                    }
                }, (error) => {
                    console.error('L·ªói khi t·∫£i d·ªØ li·ªáu t·ª´ Firebase:', error);
                });
            }
            
            function populateFormData(formData) {
                if (!formData.deliveryInfo) return;
                
                document.getElementById('supplierName').value = formData.deliveryInfo.supplier || '';
                document.getElementById('invoiceNumber').value = formData.deliveryInfo.invoice || '';
                document.getElementById('contractNumber').value = formData.deliveryInfo.contract || '';
                document.getElementById('receivingPlace').value = formData.deliveryInfo.place || '003 Carlion 5 262/3 L≈©y B√°n B√≠ch - Ph∆∞·ªùng T√¢n Ph√∫ -Tp. H·ªì Ch√≠ Minh';
                document.getElementById('receivingDate').value = formData.deliveryInfo.date || '';
                document.getElementById('receivingTime').value = formData.deliveryInfo.time || '';
                document.getElementById('inspectionResult').value = formData.deliveryInfo.inspection || '';
                document.getElementById('deliveryTransport').value = formData.deliveryInfo.deliveryTransport || '';
                document.getElementById('paymentCondition').value = formData.deliveryInfo.paymentCondition || '';
                document.getElementById('otherRequirements').value = formData.deliveryInfo.otherRequirements || '';
                document.getElementById('preparerName').value = formData.deliveryInfo.preparerName || '';
                // C·∫¨P NH·∫¨T: Fallback v·ªÅ t√™n SOP T√¢m n·∫øu d·ªØ li·ªáu r·ªóng
                document.getElementById('warehouseStaffName').value = formData.deliveryInfo.warehouseStaffName || 'Nguy·ªÖn Minh T√¢m';
                
                productTableBody.innerHTML = '';
                productCount = 0;
                
                if (formData.products && formData.products.length > 0) {
                    formData.products.forEach(product => {
                        addNewProductRow(product);
                    });
                }
            }
            
            function loadSavedFiles() {
                if (!db) return;
                
                db.collection('savedPdfs')
                    .orderBy('createdAt', 'desc')
                    .limit(10)
                    .onSnapshot((snapshot) => {
                        const filesList = document.getElementById('filesList');
                        filesList.innerHTML = '';
                        if (snapshot.empty) {
                            filesList.innerHTML = '<div class="file-item"><div class="file-info"><div class="file-name">Ch∆∞a c√≥ file n√†o ƒë∆∞·ª£c l∆∞u</div></div></div>';
                            return;
                        }
                        snapshot.forEach((doc) => {
                            const fileData = doc.data();
                            const fileItem = document.createElement('div');
                            fileItem.className = 'file-item';
                            fileItem.innerHTML = `
                                <div class="file-info">
                                    <div class="file-name">${fileData.fileName}</div>
                                    <div class="file-date">${new Date(fileData.createdAt).toLocaleString('vi-VN')}</div>
                                </div>
                                <div class="file-actions">
                                    <button class="btn-secondary download-pdf" data-url="${fileData.downloadURL}" style="padding: 4px 8px; font-size: 11px;">T·∫£i v·ªÅ</button>
                                </div>
                            `;
                            filesList.appendChild(fileItem);
                        });
                        document.querySelectorAll('.download-pdf').forEach(button => {
                            button.addEventListener('click', function() {
                                const url = this.getAttribute('data-url');
                                window.open(url, '_blank');
                            });
                        });
                    });
            }
            
            function savePdfToFirebase(pdfBlob, fileName) {
                if (!storage || !db) {
                    showMessage('Kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi Firebase', 'error');
                    return;
                }
                const storageRef = storage.ref();
                const pdfRef = storageRef.child(`pdfs/${fileName}`);
                
                pdfRef.put(pdfBlob).then((snapshot) => {
                    return snapshot.ref.getDownloadURL();
                }).then((downloadURL) => {
                    return db.collection('savedPdfs').add({
                        fileName: fileName,
                        downloadURL: downloadURL,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }).then(() => {
                    showMessage('PDF ƒë√£ ƒë∆∞·ª£c l∆∞u l√™n Firebase th√†nh c√¥ng!', 'success');
                }).catch((error) => {
                    console.error('L·ªói khi l∆∞u PDF:', error);
                    showMessage('L·ªói khi l∆∞u PDF l√™n Firebase', 'error');
                });
            }
            
            const dataFileInput = document.getElementById('dataFile');
            dataFileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const firstSheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[firstSheetName];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                            
                            let headerRowIndex = -1;
                            let headerRow = [];
                            for (let i = 0; i < jsonData.length; i++) {
                                const row = jsonData[i];
                                if (row && row.includes('STT') && (row.includes('T√™n H√†ng H√≥a') || row.includes('T√™n h√†ng'))) {
                                    headerRowIndex = i;
                                    headerRow = row;
                                    break;
                                }
                            }
                            
                            if (headerRowIndex === -1) {
                                showMessage('Kh√¥ng t√¨m th·∫•y h√†ng ti√™u ƒë·ªÅ trong file Excel!', 'error');
                                return;
                            }
                            
                            const columnMapping = {};
                            headerRow.forEach((header, index) => {
                                if (header) columnMapping[header] = index;
                            });
                            
                            productTableBody.innerHTML = '';
                            productCount = 0;
                            let importedCount = 0;
                            
                            for (let i = headerRowIndex + 1; i < jsonData.length; i++) {
                                const row = jsonData[i];
                                if (row && row.length > 0 && row[0] !== undefined && row[0] !== '') {
                                    const productData = {};
                                    Object.keys(columnMapping).forEach(header => {
                                        const colIndex = columnMapping[header];
                                        if (colIndex < row.length) productData[header] = row[colIndex];
                                    });
                                    addNewProductRow(productData);
                                    importedCount++;
                                }
                            }
                            showMessage(`ƒê√£ t·∫£i l√™n ${importedCount} s·∫£n ph·∫©m t·ª´ file Excel!`, 'success');
                            saveDataToFirebase();
                        } catch (error) {
                            console.error('L·ªói khi ƒë·ªçc file Excel:', error);
                            showMessage('L·ªói khi ƒë·ªçc file Excel: ' + error.message, 'error');
                        }
                    };
                    reader.readAsArrayBuffer(file);
                }
            });
            
            document.getElementById('saveBtn').addEventListener('click', function() { saveDataAndCreatePDF(); });
            function saveDataAndCreatePDF() {
                saveDataToFirebase();
                createAndSavePDF();
            }
            
            function createAndSavePDF() {
                const noPrintElements = document.querySelectorAll('.no-print');
                noPrintElements.forEach(el => el.style.display = 'none');
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
                const element = document.getElementById('contentToPrint');
                
                html2canvas(element, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    width: element.scrollWidth,
                    height: element.scrollHeight
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 0;
                    
                    doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        doc.addPage();
                        doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }
                    
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                    const fileName = `Bien-ban-nhan-hang-${timestamp}.pdf`;
                    
                    const pdfBlob = doc.output('blob');
                    savePdfToFirebase(pdfBlob, fileName);
                    doc.save(fileName);
                    noPrintElements.forEach(el => el.style.display = '');
                });
            }

            document.getElementById('exportExcelBtn').addEventListener('click', function() { exportToExcel(); });
            function exportToExcel() {
                const wb = XLSX.utils.book_new();
                const excelData = [
                    ['BI√äN B·∫¢N NH·∫¨N H√ÄNG - C√îNG TY TNHH TM DV K·∫æT GIAO PH√ÅT TRI·ªÇN QU·ªêC T·∫æ IDECO'],
                    ['M√£ bi√™n b·∫£n: BMI.06', '', '', '', '', '', `Ng√†y xu·∫•t: ${new Date().toLocaleDateString('vi-VN')}`],
                    [''],
                    ['TH√îNG TIN NH·∫¨N H√ÄNG'],
                    ['T√™n nh√† cung c·∫•p:', document.getElementById('supplierName').value, '', '', 'H√≥a ƒë∆°n:', document.getElementById('invoiceNumber').value],
                    ['S·ªë h·ª£p ƒë·ªìng:', document.getElementById('contractNumber').value, '', '', 'N∆°i nh·∫≠n h√†ng:', document.getElementById('receivingPlace').value],
                    ['Ng√†y nh·∫≠n:', document.getElementById('receivingDate').value, '', '', 'Gi·ªù nh·∫≠n:', document.getElementById('receivingTime').value],
                    ['K·∫øt qu·∫£ ki·ªÉm nghi·ªám:', document.getElementById('inspectionResult').value],
                    [''],
                    ['TH√îNG TIN GIAO NH·∫¨N'],
                    ['Giao nh·∫≠n v·∫≠n chuy·ªÉn:', document.getElementById('deliveryTransport').value],
                    ['ƒêi·ªÅu ki·ªán thanh to√°n:', document.getElementById('paymentCondition').value],
                    ['C√°c y√™u c·∫ßu kh√°c:', document.getElementById('otherRequirements').value],
                    [''],
                    ['DANH M·ª§C THU·ªêC NH·∫¨N H√ÄNG'],
                    ['STT', 'T√™n h√†ng', 'ƒê∆°n v·ªã t√≠nh', 'S·ªë L√¥', 'H·∫°n s·ª≠ d·ª•ng', 'S·ªë l∆∞·ª£ng Th·ª±c t·∫ø', 'Th·ª´a', 'Thi·∫øu', 'H∆∞ h·ªèng', 'T√¨nh tr·∫°ng', 'Ghi ch√∫']
                ];
                
                const productRows = productTableBody.querySelectorAll('tr');
                productRows.forEach(row => {
                    const productRow = [
                        row.cells[0].textContent,
                        row.querySelector('textarea[name="productName"]').value, // S·ª≠a: l·∫•y value t·ª´ textarea
                        row.querySelector('input[name="unit"]').value,
                        row.querySelector('input[name="lotNumber"]').value,
                        row.querySelector('input[name="expiryDate"]').value,
                        row.querySelector('input[name="actualQuantity"]').value,
                        row.querySelector('input[name="excessQuantity"]').value,
                        row.querySelector('input[name="shortageQuantity"]').value,
                        row.querySelector('input[name="damagedQuantity"]').value,
                        row.querySelector('select[name="packageCondition"]').value,
                        row.querySelector('input[name="note"]').value
                    ];
                    excelData.push(productRow);
                });
                
                excelData.push(['']);
                excelData.push(['T·ªîNG H·ª¢P']);
                excelData.push(['T·ªïng s·ªë s·∫£n ph·∫©m:', productRows.length]);
                excelData.push(['T·ªïng s·ªë l∆∞·ª£ng th·ª±c t·∫ø:', calculateTotal('actualQuantity')]);
                excelData.push(['']);
                
                const conditionStats = countPackageConditions();
                Object.keys(conditionStats).forEach(condition => {
                    excelData.push([condition + ':', conditionStats[condition]]);
                });
                
                excelData.push(['']);
                excelData.push(['NG∆Ø·ªúI L·∫¨P BI√äN B·∫¢N', '', '', '', '', 'B·ªò PH·∫¨N KHO']);
                excelData.push([document.getElementById('preparerName').value, '', '', '', '', document.getElementById('warehouseStaffName').value]);
                
                const ws = XLSX.utils.aoa_to_sheet(excelData);
                XLSX.utils.book_append_sheet(wb, ws, 'Bi√™n b·∫£n nh·∫≠n h√†ng');
                XLSX.writeFile(wb, `Bien-ban-nhan-hang-${formatDateForFileName()}.xlsx`);
                showMessage('ƒê√£ xu·∫•t file Excel th√†nh c√¥ng!', 'success');
            }

            function calculateTotal(fieldName) {
                let total = 0;
                const productRows = productTableBody.querySelectorAll('tr');
                productRows.forEach(row => {
                    const input = row.querySelector(`input[name="${fieldName}"]`);
                    if (input && input.value) total += parseInt(input.value) || 0;
                });
                return total;
            }

            function countPackageConditions() {
                const conditions = {};
                const productRows = productTableBody.querySelectorAll('tr');
                productRows.forEach(row => {
                    const select = row.querySelector('select[name="packageCondition"]');
                    if (select) {
                        const condition = select.value;
                        conditions[condition] = (conditions[condition] || 0) + 1;
                    }
                });
                return conditions;
            }

            function formatDateForFileName() {
                const now = new Date();
                return `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}-${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}`;
            }
            
            const exportPdfBtn = document.getElementById('exportPdfBtn');
            const pdfOptions = document.getElementById('pdfOptions');
            const confirmExportPdf = document.getElementById('confirmExportPdf');
            const cancelExportPdf = document.getElementById('cancelExportPdf');
            
            exportPdfBtn.addEventListener('click', function() { pdfOptions.style.display = 'block'; });
            cancelExportPdf.addEventListener('click', function() { pdfOptions.style.display = 'none'; });
            
            confirmExportPdf.addEventListener('click', function() {
                const orientation = document.querySelector('input[name="pageOrientation"]:checked').value;
                // T·∫°m th·ªùi ·∫©n c√°c n√∫t khi xu·∫•t PDF
                const noPrintElements = document.querySelectorAll('.no-print');
                noPrintElements.forEach(el => el.style.display = 'none');
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: orientation, unit: 'mm', format: 'a4' });
                const element = document.getElementById('contentToPrint');
                
                html2canvas(element, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    width: element.scrollWidth,
                    height: element.scrollHeight
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 0;
                    
                    doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        doc.addPage();
                        doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }
                    doc.save('Bien-ban-nhan-hang.pdf');
                    noPrintElements.forEach(el => el.style.display = '');
                });
                pdfOptions.style.display = 'none';
            });
            
            document.getElementById('printBtn').addEventListener('click', function() { window.print(); });
            
            document.getElementById('resetBtn').addEventListener('click', function() {
                if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën l√†m m·ªõi bi√™n b·∫£n? T·∫•t c·∫£ d·ªØ li·ªáu ch∆∞a l∆∞u s·∫Ω b·ªã m·∫•t.')) {
                    document.querySelectorAll('input, select, textarea').forEach(element => {
                        // Gi·ªØ l·∫°i ƒê·ªãa ch·ªâ v√† T√™n SOP T√¢m
                        if (element.id !== 'receivingPlace' && element.id !== 'warehouseStaffName') {
                            element.value = '';
                        }
                    });
                    productTableBody.innerHTML = '';
                    productCount = 0;
                    const now = new Date();
                    document.getElementById('receivingDate').valueAsDate = now;
                    document.getElementById('receivingTime').value = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                    saveDataToFirebase();
                }
            });
            
            const now = new Date();
            document.getElementById('receivingDate').valueAsDate = now;
            document.getElementById('receivingTime').value = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            
            document.querySelectorAll('input, select, textarea').forEach(element => {
                element.addEventListener('change', function() { saveDataToFirebase(); });
            });
        });
    </script>
</body>
</html>
