<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω SOP - ƒê√£ s·ª≠a l·ªói tr√πng l·∫∑p</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #2c5aa0;
            --secondary-color: #e74c3c;
            --accent-color: #27ae60;
            --light-bg: #f8f9fa;
            --border-color: #dee2e6;
            --text-color: #333;
        }
        
        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { margin: 0; padding: 15px; background-color: #f0f2f5; color: var(--text-color); font-size: 14px; }
        .container { max-width: 1200px; margin: 0 auto; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
        
        /* --- Header & Logo --- */
        .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; border-bottom: 2px solid var(--border-color); padding-bottom: 15px; }
        .logo-container { width: 120px; height: 80px; display: flex; align-items: center; justify-content: center; }
        .logo { max-width: 100%; max-height: 100%; }
        .company-info { flex-grow: 1; text-align: center; padding: 0 15px; }
        .company-name { font-size: 18px; font-weight: bold; margin-bottom: 5px; color: var(--primary-color); }
        .document-title { font-size: 20px; font-weight: bold; margin: 8px 0; color: var(--secondary-color); text-transform: uppercase; }
        .document-code { font-size: 14px; margin-bottom: 5px; color: #6c757d; }
        
        /* --- Forms --- */
        .compact-form-section { margin-bottom: 20px; padding: 15px; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--light-bg); }
        .form-row { display: flex; flex-wrap: wrap; margin-bottom: 10px; gap: 10px; }
        .form-group { flex: 1; min-width: 180px; }
        .compact-form-group { flex: 1; min-width: 150px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: var(--primary-color); font-size: 13px; }
        input, select, textarea { width: 100%; padding: 8px 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 13px; transition: all 0.2s; }
        
        textarea.auto-resize { width: 100%; resize: none; overflow: hidden; min-height: 34px; padding: 8px 10px; line-height: 1.4; background-color: white; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 2px rgba(44, 90, 160, 0.1); }

        /* --- Table --- */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); table-layout: fixed; }
        th, td { border: 1px solid var(--border-color); padding: 8px; text-align: center; word-wrap: break-word; }
        th { background-color: var(--primary-color); color: white; font-weight: 600; font-size: 12px; position: relative; }
        
        .resizer { position: absolute; top: 0; right: 0; width: 5px; cursor: col-resize; user-select: none; height: 100%; z-index: 10; }
        .resizer:hover, .resizing { background-color: var(--secondary-color); opacity: 0.7; }
        tr:nth-child(even) { background-color: #f8f9fa; }

        /* --- Buttons --- */
        .action-buttons { margin-top: 20px; display: flex; justify-content: space-between; }
        .utility-buttons { margin-top: 10px; display: flex; justify-content: flex-start; gap: 8px; }
        button { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.3s ease; display: flex; align-items: center; gap: 5px; }
        button:hover { transform: translateY(-1px); box-shadow: 0 3px 5px rgba(0,0,0,0.1); }
        
        .btn-primary { background-color: var(--accent-color); color: white; }
        .btn-secondary { background-color: var(--primary-color); color: white; }
        .btn-danger { background-color: #e74c3c; color: white; }
        .btn-warning { background-color: #f39c12; color: white; }
        .btn-info { background-color: #3498db; color: white; }
        .btn-purple { background-color: #9b59b6; color: white; }
        .btn-teal { background-color: #009688; color: white; }

        /* --- Upload & Info Sections --- */
        .upload-section { margin-top: 20px; padding: 15px; border: 2px dashed #bdc3c7; border-radius: 6px; background-color: #f8f9fa; }
        .receiving-info { margin-top: 15px; padding: 12px; background-color: #ecf0f1; border-radius: 5px; }
        .receiving-info-row { display: flex; margin-bottom: 8px; align-items: center; }
        .receiving-info-label { min-width: 180px; font-weight: 600; color: var(--primary-color); font-size: 13px; }
        .receiving-info-input { flex-grow: 1; padding: 6px 10px; border: 1px solid var(--border-color); border-radius: 4px; background-color: white; }
        
        /* --- Signature --- */
        .signature-section { margin-top: 20px; display: flex; justify-content: space-between; gap: 10px; }
        .signature-box { text-align: center; width: 30%; }
        .signature-line { border-top: 1px solid var(--text-color); margin-top: 40px; padding-top: 5px; font-weight: 600; font-size: 13px; text-transform: uppercase; }
        
        /* --- Others --- */
        .saved-files-section { margin-top: 20px; padding: 15px; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--light-bg); }
        .files-list { max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 4px; padding: 10px; background-color: white; }
        .file-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid var(--border-color); }
        .status-indicator { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; }
        .status-online { background-color: var(--accent-color); }
        .status-offline { background-color: #e74c3c; }
        .alert { padding: 10px; border-radius: 4px; margin: 8px 0; font-size: 13px; }
        .alert-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .compact-table { font-size: 12px; }
        .compact-table th, .compact-table td { padding: 6px 4px; vertical-align: middle; }
        .no-print { display: block; }
        .section-title { font-size: 16px; font-weight: 600; color: var(--primary-color); margin-bottom: 10px; border-bottom: 1px solid var(--border-color); }

        /* --- PRINT FIX --- */
        .print-substitution {
            display: block;
            width: 100%;
            font-family: inherit;
            font-size: 13px;
            padding: 8px 10px;
            line-height: 1.4;
            white-space: pre-wrap;
            word-break: break-word;
            min-height: 34px;
        }

        @media print {
            .no-print, .no-print * { display: none !important; }
            body { padding: 0; background-color: white; }
            .container { box-shadow: none; padding: 10px; max-width: 100%; border: none; }
            table { font-size: 12px; }
            textarea, input[type="text"], input[type="date"], input[type="time"], input[type="number"] {
                border: none !important;
                background: transparent !important;
                padding: 0 !important;
            }
        }

        /* --- MODAL --- */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background-color: #fefefe; padding: 20px; border-radius: 8px; width: 90%; max-width: 1000px; max-height: 90vh; overflow-y: auto; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .close-modal { float: right; font-size: 24px; font-weight: bold; cursor: pointer; color: #aaa; }
        .close-modal:hover { color: black; }
        .paste-area { width: 100%; height: 150px; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; border-radius: 4px; font-family: monospace; }
        .mapping-container { overflow-x: auto; margin-top: 15px; border: 1px solid #eee; }
        .mapping-table { width: 100%; border-collapse: collapse; }
        .mapping-table th { background-color: #f0f2f5; color: #333; padding: 5px; border: 1px solid #ddd; }
        .mapping-table td { padding: 5px; border: 1px solid #ddd; font-size: 12px; white-space: nowrap; }
        .col-select { width: 100%; padding: 5px; border: 1px solid var(--accent-color); border-radius: 4px; font-weight: bold; color: var(--primary-color); }
    </style>
</head>
<body>
    <div class="container" id="contentToPrint">
        <div class="header">
            <div class="logo-container">
                <img src="https://cdn.imgpile.com/f/ZMtwhK9_xl.png" alt="Logo c√¥ng ty" class="logo">
            </div>
            <div class="company-info">
                <div class="company-name">C√îNG TY TNHH TM DV K·∫æT GIAO PH√ÅT TRI·ªÇN QU·ªêC T·∫æ IDECO</div>
                <div class="document-title">BI√äN B·∫¢N NH·∫¨N H√ÄNG</div>
                <div class="document-code">BMI.06</div>
            </div>
            <div class="logo-container" style="visibility: hidden;"></div>
        </div>

        <div id="connectionStatus" class="alert" style="display: none;">
            <span class="status-indicator status-offline"></span>
            <span id="statusText">ƒêang k·∫øt n·ªëi...</span>
        </div>

        <div class="compact-form-section">
            <div class="section-title">Th√¥ng tin nh·∫≠n h√†ng</div>
            <div class="form-row">
                <div class="compact-form-group">
                    <label for="supplierName">T√™n nh√† cung c·∫•p</label>
                    <input type="text" id="supplierName" list="supplierList" placeholder="Nh·∫≠p ho·∫∑c ch·ªçn nh√† cung c·∫•p..." autocomplete="off">
                    <datalist id="supplierList"></datalist>
                </div>
                <div class="compact-form-group">
                    <label for="invoiceNumber">H√≥a ƒë∆°n</label>
                    <input type="text" id="invoiceNumber">
                </div>
                <div class="compact-form-group">
                    <label for="contractNumber">S·ªë h·ª£p ƒë·ªìng</label>
                    <input type="text" id="contractNumber">
                </div>
            </div>
            <div class="form-row">
                <div class="compact-form-group">
                    <label for="receivingPlace">N∆°i nh·∫≠n h√†ng</label>
                    <input type="text" id="receivingPlace">
                </div>
                <div class="compact-form-group">
                    <label for="receivingDate">Ng√†y nh·∫≠n</label>
                    <input type="date" id="receivingDate">
                </div>
                <div class="compact-form-group">
                    <label for="receivingTime">Gi·ªù nh·∫≠n</label>
                    <input type="time" id="receivingTime">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="inspectionResult">K·∫øt qu·∫£ ki·ªÉm nghi·ªám</label>
                    <textarea id="inspectionResult" rows="2"></textarea>
                </div>
            </div>
        </div>

        <div class="compact-form-section">
            <div class="section-title">Danh m·ª•c thu·ªëc nh·∫≠n h√†ng</div>
            <table id="productTable" class="compact-table">
                <thead>
                    <tr>
                        <th style="width: 40px;">STT</th>
                        <th style="width: 200px;">T√™n h√†ng</th>
                        <th style="width: 80px;">ƒêVT</th>
                        <th style="width: 90px;">S·ªë L√¥</th>
                        <th style="width: 90px;">H·∫°n SD</th>
                        <th style="width: 80px;">SL<br>Th·ª±c t·∫ø</th>
                        <th style="width: 60px;">Th·ª´a</th>
                        <th style="width: 60px;">Thi·∫øu</th>
                        <th style="width: 60px;">H·ªèng</th>
                        <th style="width: 100px;">T√¨nh tr·∫°ng</th>
                        <th style="width: 100px;">Ghi ch√∫</th>
                        <th style="width: 50px;" class="no-print">X√≥a</th>
                    </tr>
                </thead>
                <tbody id="productTableBody"></tbody>
            </table>
            <button type="button" id="addProductBtn" class="btn-secondary no-print" style="margin-top: 10px;"><span>+</span> Th√™m s·∫£n ph·∫©m</button>
        </div>

        <div class="receiving-info">
            <div class="receiving-info-row"><div class="receiving-info-label">Giao nh·∫≠n v·∫≠n chuy·ªÉn:</div><input type="text" class="receiving-info-input" id="deliveryTransport"></div>
            <div class="receiving-info-row"><div class="receiving-info-label">ƒêi·ªÅu ki·ªán thanh to√°n:</div><input type="text" class="receiving-info-input" id="paymentCondition"></div>
            <div class="receiving-info-row"><div class="receiving-info-label">C√°c y√™u c·∫ßu kh√°c:</div><input type="text" class="receiving-info-input" id="otherRequirements"></div>
        </div>

        <div class="signature-section">
            <div class="signature-box">
                <div class="signature-line">B·ªô Ph·∫≠n Kho/K·∫ø to√°n</div>
                <input type="text" id="deptStaffName" placeholder="H·ªç t√™n" style="width: 100%; margin-top: 5px; text-align: center; border: none; border-bottom: 1px dashed #ccc; background: transparent; outline: none;">
            </div>
            <div class="signature-box">
                <div class="signature-line">Ng∆∞·ªùi l·∫≠p bi√™n b·∫£n</div>
                <input type="text" id="preparerName" placeholder="H·ªç t√™n" style="width: 100%; margin-top: 5px; text-align: center; border: none; border-bottom: 1px dashed #ccc; background: transparent; outline: none;">
            </div>
            <div class="signature-box">
                <div class="signature-line">Ph·ª• tr√°ch chuy√™n m√¥n</div>
                <input type="text" id="warehouseStaffName" placeholder="H·ªç t√™n" style="width: 100%; margin-top: 5px; text-align: center; border: none; border-bottom: 1px dashed #ccc; background: transparent; outline: none;">
            </div>
        </div>

        <div class="upload-section no-print">
            <div class="section-title">Nh·∫≠p d·ªØ li·ªáu (Upload Excel ho·∫∑c D√°n t·ª´ Clipboard)</div>
            <div class="form-row" style="align-items: flex-end;">
                <div class="form-group">
                    <label for="dataFile">Ch·ªçn file Excel (.xlsx, .xls)</label>
                    <input type="file" id="dataFile" accept=".xlsx,.xls">
                </div>
                <div class="form-group" style="flex: 0 0 auto; display: flex; align-items: center; padding-bottom: 5px;">
                    <span style="margin: 0 10px; font-weight: bold;">HO·∫∂C</span>
                </div>
                <div class="form-group">
                    <button type="button" id="openPasteModalBtn" class="btn-teal" style="width: 100%; justify-content: center; padding: 10px;">
                        üìã D√°n d·ªØ li·ªáu t·ª´ Excel/Sheet
                    </button>
                </div>
            </div>
            <div id="uploadMessage"></div>
        </div>

        <div class="utility-buttons no-print">
            <button type="button" id="cameraAiBtn" class="btn-purple" onclick="openCameraAI()">üì∑ Ch·ª•pAI</button>
            <button type="button" id="erpHomeBtn" class="btn-purple" onclick="openERPHome()">üè† ERP HOME</button>
        </div>

        <div class="action-buttons no-print">
            <button type="button" id="saveBtn" class="btn-primary">üíæ L∆∞u & T·∫°o PDF</button>
            <button type="button" id="exportExcelBtn" class="btn-info">üìä Xu·∫•t Excel</button>
            <button type="button" id="exportPdfBtn" class="btn-warning">üìÑ Xu·∫•t PDF</button>
            <button type="button" id="printBtn" class="btn-secondary">üñ®Ô∏è In</button>
            <button type="button" id="resetBtn" class="btn-danger">üîÑ L√†m m·ªõi</button>
        </div>

        <div class="saved-files-section no-print">
            <div class="section-title">Danh s√°ch file PDF ƒë√£ l∆∞u</div>
            <div class="files-list" id="filesList"><div class="file-item"><div class="file-info"><div class="file-name">ƒêang t·∫£i danh s√°ch...</div></div></div></div>
        </div>
        
        <div class="pdf-options no-print" id="pdfOptions" style="display: none;">
            <h4 style="margin-top: 0;">T√πy ch·ªçn xu·∫•t PDF:</h4>
            <label><input type="radio" name="pageOrientation" value="portrait" checked> Kh·ªï d·ªçc (A4)</label>
            <label><input type="radio" name="pageOrientation" value="landscape"> Kh·ªï ngang (A4)</label>
            <button type="button" id="confirmExportPdf" class="btn-primary">X√°c nh·∫≠n</button>
            <button type="button" id="cancelExportPdf" class="btn-danger">H·ªßy</button>
        </div>
    </div>

    <div id="pasteModal" class="modal no-print">
        <div class="modal-content">
            <span class="close-modal" id="closePasteModal">&times;</span>
            <h3 style="margin-top: 0; color: var(--primary-color);">D√°n v√† √Ånh x·∫° d·ªØ li·ªáu</h3>
            <p style="font-size: 13px; color: #666;">Copy d·ªØ li·ªáu t·ª´ Excel (bao g·ªìm c·∫£ nhi·ªÅu c·ªôt) v√† d√°n v√†o √¥ b√™n d∆∞·ªõi. Sau ƒë√≥ ch·ªçn c·ªôt t∆∞∆°ng ·ª©ng ·ªü b·∫£ng xem tr∆∞·ªõc.</p>
            <textarea id="pasteInput" class="paste-area" placeholder="D√°n d·ªØ li·ªáu v√†o ƒë√¢y (Ctrl + V)..."></textarea>
            <div id="previewContainer" style="display: none;">
                <h4 style="margin-bottom: 5px;">Xem tr∆∞·ªõc & Ch·ªçn c·ªôt (Mapping):</h4>
                <div class="mapping-container">
                    <table class="mapping-table" id="mappingTable"></table>
                </div>
                <div style="margin-top: 15px; text-align: right;">
                    <button type="button" id="processPasteBtn" class="btn-primary">üì• Nh·∫≠p d·ªØ li·ªáu v√†o b·∫£ng</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG & INIT ---
        const firebaseConfig = { apiKey: "AIzaSyCM_gZ1DEOtUwB0Ii-dm-6jIpxydoJU4-E", authDomain: "dulieuthuoc-d532e.firebaseapp.com", projectId: "dulieuthuoc-d532e", storageBucket: "dulieuthuoc-d532e.firebasestorage.app", messagingSenderId: "70002622120", appId: "1:70002622120:web:9676e1616a0774bae28c9d", measurementId: "G-LQ5P054T97" };
        let db, storage;

        try { firebase.initializeApp(firebaseConfig); db = firebase.firestore(); storage = firebase.storage(); console.log("Firebase OK"); } 
        catch (error) { console.error("Firebase error:", error); }

        // --- UTILS ---
        function autoResize(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }
        function openCameraAI() { window.open('https://idecochupanh.netlify.app', '_blank'); }
        function openERPHome() { window.open('https://erp-ideco.skyit.vn/#/app/dashboard/main', '_blank'); }
        function showMessage(msg, type = 'success') { const el = document.getElementById('uploadMessage'); el.innerHTML = `<div class="alert alert-${type}">${msg}</div>`; setTimeout(() => el.innerHTML = '', 5000); }
        
        function formatDateForInput(dateString) {
            if (!dateString) return '';
            if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateString)) {
                const parts = dateString.split('/');
                return `${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`;
            }
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) return dateString;
            return dateString;
        }

        // --- FIX L·ªñI CHE CH·ªÆ & TR√ôNG L·∫∂P KHI IN/PDF ---
        function toggleInputsForExport(isExporting) {
            // B∆∞·ªõc 1: X√≥a s·∫°ch c√°c l·ªõp gi·∫£ l·∫≠p c≈© n·∫øu c√≥ ƒë·ªÉ tr√°nh tr√πng l·∫∑p
            document.querySelectorAll('.print-substitution').forEach(el => el.remove());

            document.querySelectorAll('textarea, input:not([type="button"]):not([type="radio"]):not([type="checkbox"]):not([type="file"]), select').forEach(el => {
                if (isExporting) {
                    const div = document.createElement('div');
                    div.className = 'print-substitution';
                    div.style.width = el.style.width || '100%';
                    div.style.textAlign = window.getComputedStyle(el).textAlign;
                    
                    if (el.tagName === 'SELECT') {
                        div.textContent = el.options[el.selectedIndex]?.text || '';
                    } else {
                        div.textContent = el.value;
                    }
                    div.dataset.subFor = el.name || el.id;
                    
                    el.style.display = 'none';
                    el.parentNode.insertBefore(div, el);
                } else {
                    el.style.display = '';
                }
            });
        }

        window.onbeforeprint = () => toggleInputsForExport(true);
        window.onafterprint = () => toggleInputsForExport(false);

        // --- COLUMN RESIZE ---
        function makeTableResizable() {
            document.querySelectorAll('#productTable th').forEach(col => {
                if (!col.querySelector('.resizer') && !col.classList.contains('no-print')) {
                    const resizer = document.createElement('div'); resizer.className = 'resizer'; col.appendChild(resizer);
                    let x = 0, w = 0;
                    const md = (e) => { x = e.clientX; w = parseInt(window.getComputedStyle(col).width); document.addEventListener('mousemove', mm); document.addEventListener('mouseup', mu); resizer.classList.add('resizing'); };
                    const mm = (e) => { col.style.width = `${w + e.clientX - x}px`; };
                    const mu = () => { document.removeEventListener('mousemove', mm); document.removeEventListener('mouseup', mu); resizer.classList.remove('resizing'); };
                    resizer.addEventListener('mousedown', md);
                }
            });
        }

        // --- FIREBASE SUPPLIERS ---
        function loadSuppliers() {
            if (!db) return;
            db.collection('suppliers').get().then(qs => {
                const dl = document.getElementById('supplierList'); dl.innerHTML = '';
                qs.forEach(doc => { if(doc.data().name) { const op = document.createElement('option'); op.value = doc.data().name; dl.appendChild(op); }});
            });
        }
        function saveSupplier(name) {
            if (!db || !name) return;
            db.collection('suppliers').where('name', '==', name).get().then(qs => {
                if (qs.empty) db.collection('suppliers').add({ name: name, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
            });
        }

        // --- MAIN LOGIC ---
        document.addEventListener('DOMContentLoaded', function() {
            makeTableResizable();
            loadSuppliers();
            loadDataFromFirebase();
            loadSavedFiles();

            const cs = document.getElementById('connectionStatus');
            if (db) db.enableNetwork().then(() => { cs.style.display = 'block'; cs.className = 'alert alert-success'; cs.innerHTML = '<span class="status-indicator status-online"></span> K·∫øt n·ªëi OK'; }).catch(e => { cs.style.display = 'block'; cs.className = 'alert alert-error'; cs.innerHTML = 'L·ªói m·∫°ng'; });

            const now = new Date();
            document.getElementById('receivingDate').valueAsDate = now;
            document.getElementById('receivingTime').value = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;

            document.getElementById('addProductBtn').addEventListener('click', () => addNewProductRow());
            document.getElementById('saveBtn').addEventListener('click', saveDataAndCreatePDF);
            document.getElementById('resetBtn').addEventListener('click', resetForm);
            document.querySelectorAll('input, select, textarea').forEach(el => el.addEventListener('change', saveDataToFirebase));

            // --- PASTE MODAL LOGIC ---
            const modal = document.getElementById('pasteModal');
            const pasteInput = document.getElementById('pasteInput');
            const previewContainer = document.getElementById('previewContainer');
            const mappingTable = document.getElementById('mappingTable');
            let parsedData = [];

            document.getElementById('openPasteModalBtn').onclick = () => { modal.style.display = 'flex'; pasteInput.value = ''; previewContainer.style.display = 'none'; pasteInput.focus(); };
            document.getElementById('closePasteModal').onclick = () => { modal.style.display = 'none'; };
            window.onclick = (e) => { if (e.target == modal) modal.style.display = 'none'; };

            pasteInput.addEventListener('input', function() {
                const text = this.value.trim();
                if (!text) { previewContainer.style.display = 'none'; return; }
                const rows = text.split(/\n/);
                parsedData = rows.map(row => row.split(/\t/));
                if (parsedData.length > 0) {
                    renderPreview(parsedData);
                    previewContainer.style.display = 'block';
                }
            });

            function renderPreview(data) {
                mappingTable.innerHTML = '';
                if (data.length === 0) return;
                const colCount = data[0].length;
                const thead = document.createElement('tr');
                const options = [{v:'skip',t:'B·ªè qua'},{v:'productName',t:'T√™n h√†ng'},{v:'unit',t:'ƒê∆°n v·ªã'},{v:'lotNumber',t:'S·ªë l√¥'},{v:'expiryDate',t:'H·∫°n d√πng'},{v:'actualQuantity',t:'S·ªë l∆∞·ª£ng'},{v:'note',t:'Ghi ch√∫'}];

                for (let i = 0; i < colCount; i++) {
                    const th = document.createElement('th');
                    const select = document.createElement('select');
                    select.className = 'col-select';
                    select.dataset.colIndex = i;
                    options.forEach(opt => { const option = document.createElement('option'); option.value = opt.v; option.text = opt.t; select.appendChild(option); });
                    select.value = 'skip';
                    th.appendChild(select);
                    thead.appendChild(th);
                }
                mappingTable.appendChild(thead);
                for (let i = 0; i < Math.min(data.length, 5); i++) {
                    const tr = document.createElement('tr');
                    data[i].forEach(cell => { const td = document.createElement('td'); td.textContent = cell; tr.appendChild(td); });
                    mappingTable.appendChild(tr);
                }
            }

            document.getElementById('processPasteBtn').addEventListener('click', function() {
                const selects = document.querySelectorAll('.col-select');
                const mappings = [];
                selects.forEach(sel => { if (sel.value !== 'skip') mappings.push({ index: parseInt(sel.dataset.colIndex), field: sel.value }); });
                if (mappings.length === 0) { alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt c·ªôt d·ªØ li·ªáu!'); return; }
                let importedCount = 0;
                parsedData.forEach(row => {
                    if (row.length === 0 || (row.length === 1 && row[0].trim() === '')) return;
                    const productData = {};
                    mappings.forEach(map => { if (row[map.index] !== undefined) productData[map.field] = row[map.index].trim(); });
                    if (Object.keys(productData).length > 0) { addNewProductRow(productData); importedCount++; }
                });
                showMessage(`ƒê√£ d√°n th√†nh c√¥ng ${importedCount} d√≤ng!`, 'success');
                saveDataToFirebase();
                modal.style.display = 'none';
            });

            // --- EXCEL UPLOAD ---
            document.getElementById('dataFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                        const ws = wb.Sheets[wb.SheetNames[0]];
                        const json = XLSX.utils.sheet_to_json(ws, { header: 1 });
                        let hRowIdx = -1;
                        for(let i=0; i<json.length; i++) {
                            const r = json[i];
                            if (r && (r.includes('T√™n H√†ng H√≥a') || r.includes('T√™n h√†ng'))) { hRowIdx = i; break; }
                        }
                        if (hRowIdx === -1) { showMessage('Kh√¥ng t√¨m th·∫•y ti√™u ƒë·ªÅ!', 'error'); return; }
                        const map = {};
                        json[hRowIdx].forEach((h, i) => { if(h) map[h] = i; });
                        document.getElementById('productTableBody').innerHTML = '';
                        let count = 0;
                        for(let i=hRowIdx+1; i<json.length; i++) {
                            const r = json[i];
                            if (r && r.length) {
                                const d = {};
                                Object.keys(map).forEach(k => { if(map[k] < r.length) d[k] = r[map[k]]; });
                                addNewProductRow(d); count++;
                            }
                        }
                        showMessage(`Upload ${count} d√≤ng Excel th√†nh c√¥ng!`, 'success');
                        saveDataToFirebase();
                    } catch(err) { console.error(err); showMessage('L·ªói ƒë·ªçc file', 'error'); }
                };
                reader.readAsArrayBuffer(file);
            });

            // --- PDF EXPORT ---
            const pdfModal = document.getElementById('pdfOptions');
            document.getElementById('exportPdfBtn').onclick = () => pdfModal.style.display = 'block';
            document.getElementById('cancelExportPdf').onclick = () => pdfModal.style.display = 'none';
            
            document.getElementById('printBtn').onclick = () => { window.print(); };

            document.getElementById('confirmExportPdf').onclick = () => {
                const ori = document.querySelector('input[name="pageOrientation"]:checked').value;
                document.querySelectorAll('.no-print').forEach(e => e.style.display = 'none');
                toggleInputsForExport(true); // B·∫≠t ch·∫ø ƒë·ªô in (·∫©n input, hi·ªán text)

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: ori, unit: 'mm', format: 'a4' });
                const el = document.getElementById('contentToPrint');
                
                html2canvas(el, { scale: 2, useCORS: true, width: el.scrollWidth, height: el.scrollHeight, windowWidth: el.scrollWidth }).then(cv => {
                    const img = cv.toDataURL('image/png');
                    const w = doc.internal.pageSize.getWidth();
                    const h = doc.internal.pageSize.getHeight();
                    const imgH = cv.height * w / cv.width;
                    let left = imgH, top = 0;
                    doc.addImage(img, 'PNG', 0, top, w, imgH);
                    left -= h;
                    while (left >= 0) { top = left - imgH; doc.addPage(); doc.addImage(img, 'PNG', 0, top, w, imgH); left -= h; }
                    const name = `Bien-ban-${new Date().toISOString().slice(0,19).replace(/[-:]/g,'')}.pdf`;
                    savePdfToDb(doc.output('blob'), name);
                    doc.save(name);
                    
                    toggleInputsForExport(false); // T·∫Øt ch·∫ø ƒë·ªô in
                    document.querySelectorAll('.no-print').forEach(e => e.style.display = '');
                    pdfModal.style.display = 'none';
                });
            };
        });

        // --- CORE FUNCTIONS ---
        let productCount = 0;
        function addNewProductRow(data = {}) {
            productCount++;
            const tr = document.createElement('tr');
            const name = data['T√™n H√†ng H√≥a'] || data['T√™n h√†ng'] || data['productName'] || '';
            tr.innerHTML = `
                <td>${productCount}</td>
                <td><textarea name="productName" class="auto-resize" rows="1" oninput="autoResize(this)">${name}</textarea></td>
                <td><input type="text" name="unit" value="${data['ƒê∆°n V·ªã']||data['ƒê∆°n v·ªã t√≠nh']||data['unit']||'H·ªôp'}"></td>
                <td><input type="text" name="lotNumber" value="${data['S·ªë L√¥']||data['S·ªë l√¥']||data['lotNumber']||''}"></td>
                <td><input type="date" name="expiryDate" value="${formatDateForInput(data['H·∫°n D√πng']||data['H·∫°n s·ª≠ d·ª•ng']||data['expiryDate']||'')}"></td>
                <td><input type="number" name="actualQuantity" min="0" value="${data['T·ªïng S·ªë L∆∞·ª£ng']||data['S·ªë l∆∞·ª£ng']||data['actualQuantity']||''}"></td>
                <td><input type="number" name="excessQuantity" min="0" value="${data['excessQuantity']||0}"></td>
                <td><input type="number" name="shortageQuantity" min="0" value="${data['shortageQuantity']||0}"></td>
                <td><input type="number" name="damagedQuantity" min="0" value="${data['damagedQuantity']||0}"></td>
                <td><select name="packageCondition"><option value="Nguy√™n ven">Nguy√™n ven</option><option value="H∆∞ h·ªèng nh·∫π">H∆∞ h·ªèng nh·∫π</option><option value="H∆∞ h·ªèng n·∫∑ng">H∆∞ h·ªèng n·∫∑ng</option></select></td>
                <td><input type="text" name="note" value="${data['note']||''}"></td>
                <td class="no-print"><button type="button" class="btn-danger remove-product" style="padding: 4px;">X√≥a</button></td>
            `;
            document.getElementById('productTableBody').appendChild(tr);
            const ta = tr.querySelector('textarea'); if(ta.value) autoResize(ta);
            const sel = tr.querySelector('select'); if(data['packageCondition']) sel.value = data['packageCondition'];
            tr.querySelector('.remove-product').addEventListener('click', () => { 
                tr.remove(); 
                let i=0; document.querySelectorAll('#productTableBody tr').forEach(r => r.cells[0].textContent = ++i); productCount=i;
                saveDataToFirebase(); 
            });
        }

        function resetForm() {
            if(!confirm('X√≥a h·∫øt l√†m m·ªõi?')) return;
            document.querySelectorAll('input, select, textarea').forEach(el => {
                if(el.id!=='receivingPlace' && el.id!=='warehouseStaffName') el.value = '';
            });
            document.getElementById('productTableBody').innerHTML = ''; productCount = 0;
            const now = new Date();
            document.getElementById('receivingDate').valueAsDate = now;
            document.getElementById('receivingTime').value = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
            saveDataToFirebase();
        }

        function collectData() {
            const prods = [];
            document.querySelectorAll('#productTableBody tr').forEach(r => {
                prods.push({
                    productName: r.querySelector('[name="productName"]').value,
                    unit: r.querySelector('[name="unit"]').value,
                    lotNumber: r.querySelector('[name="lotNumber"]').value,
                    expiryDate: r.querySelector('[name="expiryDate"]').value,
                    actualQuantity: r.querySelector('[name="actualQuantity"]').value,
                    excessQuantity: r.querySelector('[name="excessQuantity"]').value,
                    shortageQuantity: r.querySelector('[name="shortageQuantity"]').value,
                    damagedQuantity: r.querySelector('[name="damagedQuantity"]').value,
                    packageCondition: r.querySelector('[name="packageCondition"]').value,
                    note: r.querySelector('[name="note"]').value
                });
            });
            return {
                deliveryInfo: {
                    supplier: document.getElementById('supplierName').value,
                    invoice: document.getElementById('invoiceNumber').value,
                    contract: document.getElementById('contractNumber').value,
                    place: document.getElementById('receivingPlace').value,
                    date: document.getElementById('receivingDate').value,
                    time: document.getElementById('receivingTime').value,
                    inspection: document.getElementById('inspectionResult').value,
                    deliveryTransport: document.getElementById('deliveryTransport').value,
                    paymentCondition: document.getElementById('paymentCondition').value,
                    otherRequirements: document.getElementById('otherRequirements').value,
                    preparerName: document.getElementById('preparerName').value,
                    warehouseStaffName: document.getElementById('warehouseStaffName').value,
                    deptStaffName: document.getElementById('deptStaffName').value
                }, products: prods
            };
        }

        function saveDataToFirebase() {
            if(!db) return;
            db.collection('deliveryRecords').doc('current').set(collectData()).catch(e => console.error(e));
        }

        function loadDataFromFirebase() {
            if(!db) return;
            db.collection('deliveryRecords').doc('current').onSnapshot(doc => {
                if(doc.exists) {
                    const d = doc.data(); const info = d.deliveryInfo || {};
                    document.getElementById('supplierName').value = info.supplier||'';
                    document.getElementById('invoiceNumber').value = info.invoice||'';
                    document.getElementById('contractNumber').value = info.contract||'';
                    document.getElementById('receivingPlace').value = info.place||'003 Carlion 5 262/3 L≈©y B√°n B√≠ch - Ph∆∞·ªùng T√¢n Ph√∫ -Tp. H·ªì Ch√≠ Minh';
                    document.getElementById('receivingDate').value = info.date||'';
                    document.getElementById('receivingTime').value = info.time||'';
                    document.getElementById('inspectionResult').value = info.inspection||'';
                    document.getElementById('deliveryTransport').value = info.deliveryTransport||'';
                    document.getElementById('paymentCondition').value = info.paymentCondition||'';
                    document.getElementById('otherRequirements').value = info.otherRequirements||'';
                    document.getElementById('preparerName').value = info.preparerName||'';
                    
                    // C·∫≠p nh·∫≠t t√™n m·∫∑c ƒë·ªãnh l√† Ph·∫°m Minh T√¢m (n·∫øu ch∆∞a c√≥ d·ªØ li·ªáu)
                    document.getElementById('warehouseStaffName').value = info.warehouseStaffName || 'Ph·∫°m Minh T√¢m';
                    document.getElementById('deptStaffName').value = info.deptStaffName||'';

                    const tb = document.getElementById('productTableBody'); tb.innerHTML = ''; productCount=0;
                    (d.products||[]).forEach(p => addNewProductRow(p));
                    showMessage('ƒê√£ ƒë·ªìng b·ªô d·ªØ li·ªáu', 'success');
                }
            });
        }

        function saveDataAndCreatePDF() {
            const sName = document.getElementById('supplierName').value.trim();
            if(sName) { saveSupplier(sName); setTimeout(loadSuppliers, 1000); }
            saveDataToFirebase();
            document.getElementById('exportPdfBtn').click();
        }

        function savePdfToDb(blob, name) {
            if(!storage||!db) return;
            storage.ref(`pdfs/${name}`).put(blob).then(s => s.ref.getDownloadURL())
            .then(url => db.collection('savedPdfs').add({ fileName: name, downloadURL: url, createdAt: firebase.firestore.FieldValue.serverTimestamp() }))
            .then(() => showMessage('PDF ƒë√£ l∆∞u', 'success'));
        }

        function loadSavedFiles() {
            if(!db) return;
            db.collection('savedPdfs').orderBy('createdAt', 'desc').limit(10).onSnapshot(sn => {
                const l = document.getElementById('filesList'); l.innerHTML = '';
                if(sn.empty) { l.innerHTML = '<div class="file-item">Ch∆∞a c√≥ file</div>'; return; }
                sn.forEach(d => {
                    const dd = d.data();
                    const div = document.createElement('div'); div.className = 'file-item';
                    div.innerHTML = `<div class="file-info"><div class="file-name">${dd.fileName}</div><div class="file-date">${new Date(dd.createdAt.toDate()).toLocaleString('vi-VN')}</div></div><button class="btn-secondary" onclick="window.open('${dd.downloadURL}')">T·∫£i</button>`;
                    l.appendChild(div);
                });
            });
        }
        
        // Export Excel
        document.getElementById('exportExcelBtn').addEventListener('click', () => {
            const wb = XLSX.utils.book_new();
            const rows = [
                ['BI√äN B·∫¢N NH·∫¨N H√ÄNG'],[''],
                ['Nh√† cung c·∫•p:', document.getElementById('supplierName').value],
                [''],
                ['STT','T√™n h√†ng','ƒêVT','S·ªë l√¥','H·∫°n d√πng','SL Th·ª±c t·∫ø','Th·ª´a','Thi·∫øu','H·ªèng','T√¨nh tr·∫°ng','Ghi ch√∫']
            ];
            document.querySelectorAll('#productTableBody tr').forEach(r => {
                const c = r.querySelectorAll('input, textarea, select');
                rows.push([r.cells[0].textContent, c[0].value, c[1].value, c[2].value, c[3].value, c[4].value, c[5].value, c[6].value, c[7].value, c[8].value, c[9].value, c[10].value]);
            });
            rows.push(['']);
            rows.push(['B·ªò PH·∫¨N KHO/K·∫æ TO√ÅN', '', 'NG∆Ø·ªúI L·∫¨P BI√äN B·∫¢N', '', 'PH·ª§ TR√ÅCH CHUY√äN M√îN']);
            rows.push([document.getElementById('deptStaffName').value, '', document.getElementById('preparerName').value, '', document.getElementById('warehouseStaffName').value]);
            
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rows), 'Sheet1');
            XLSX.writeFile(wb, 'BienBanNhanHang.xlsx');
        });
    </script>
</body>
</html>
