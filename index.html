<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phi·∫øu Nh·∫≠p Kho - In Ti√™u Chu·∫©n (Full T√≠nh NƒÉng)</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #000;
            --border-color: #000;
            --text-color: #000;
        }
        
        * { box-sizing: border-box; font-family: 'Times New Roman', Times, serif; }
        body { margin: 0; padding: 20px; background-color: #f0f2f5; color: var(--text-color); font-size: 14px; }
        
        /* --- CONTAINER: KHUNG VI·ªÄN CH√çNH A4 --- */
        .container { 
            max-width: 210mm; 
            margin: 0 auto; 
            background-color: white; 
            padding: 15mm 10mm; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            border: 4px double #000; 
            position: relative;
        }
        
        /* --- Header --- */
        .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; border-bottom: 2px solid #000; padding-bottom: 10px; }
        .logo-container { width: 100px; height: 70px; display: flex; align-items: center; justify-content: center; }
        .logo { max-width: 100%; max-height: 100%; filter: grayscale(100%); }
        .company-info { flex-grow: 1; text-align: center; padding: 0 10px; }
        .company-name { font-size: 16px; font-weight: bold; margin-bottom: 5px; text-transform: uppercase; }
        .document-title { font-size: 22px; font-weight: bold; margin: 5px 0; text-transform: uppercase; }
        .document-code { font-size: 13px; font-style: italic; }
        
        /* --- Forms --- */
        .compact-form-section { margin-bottom: 10px; }
        .input-group { margin-bottom: 10px; display: flex; gap: 10px; flex-wrap: wrap; }
        .form-control { flex: 1; min-width: 150px; }
        .form-control label { display: block; font-weight: bold; font-size: 12px; margin-bottom: 2px; }
        .form-control input, .form-control select, .form-control textarea { 
            width: 100%; padding: 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 13px; 
        }
        textarea { resize: none; overflow: hidden; }

        /* --- Table --- */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; table-layout: fixed; }
        th, td { border: 1px solid #000; padding: 5px; text-align: center; vertical-align: middle; word-wrap: break-word; color: #000; }
        th { background-color: #f0f0f0; font-weight: bold; height: 30px; }
        th:first-child { width: 35px; }
        
        /* --- Signature --- */
        .signature-section { margin-top: 30px; display: flex; justify-content: space-between; page-break-inside: avoid; }
        .signature-box { text-align: center; width: 32%; }
        .signature-title { font-weight: bold; text-transform: uppercase; font-size: 12px; margin-bottom: 50px; }
        .signature-name { border: none; border-bottom: 1px dotted #000; width: 80%; text-align: center; font-weight: bold; outline: none; background: transparent; }

        /* --- Utility & Alerts --- */
        .alert { padding: 10px; margin: 10px 0; border: 1px solid #000; font-size: 13px; display: flex; align-items: center; gap: 10px; }
        .status-indicator { width: 10px; height: 10px; border-radius: 50%; background-color: #000; }
        
        .upload-section, .action-buttons, .saved-files-section, .utility-buttons { 
            margin-top: 15px; padding: 10px; border: 1px dashed #999; background: #fafafa; 
        }
        .btn { padding: 6px 12px; cursor: pointer; background: #fff; border: 1px solid #000; color: #000; font-weight: bold; border-radius: 3px; margin-right: 5px; }
        .btn:hover { background: #000; color: #fff; }
        
        /* --- PRINT STYLE --- */
        .print-substitution { display: block; font-weight: 500; border-bottom: 1px dotted #000; padding: 2px; min-height: 20px; }
        
        @media print {
            @page { size: A4; margin: 10mm; } 
            body { padding: 0; background: white; }
            .no-print, .upload-section, .action-buttons, .utility-buttons, .saved-files-section, #connectionStatus { display: none !important; }

            .container {
                width: 100%; max-width: none; margin: 0; padding: 5px;
                border: 2px solid #000 !important; 
                box-shadow: none; height: auto;
            }

            table { border: 1px solid #000; page-break-inside: auto; }
            tr { page-break-inside: avoid; }
            input, textarea, select { display: none !important; }
            .form-control { border: none; margin-bottom: 5px; }
            .form-control label { display: inline-block; width: auto; margin-right: 5px; }
            .form-control label::after { content: ":"; }
        }

        /* --- MODAL STYLES --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border: 1px solid #000; width: 90%; max-width: 1000px; max-height: 90vh; overflow: auto; border-radius: 5px; }
        
        /* Styles cho b·∫£ng mapping trong modal */
        .mapping-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .mapping-table th { background-color: #eee; padding: 5px; border: 1px solid #ccc; }
        .mapping-table td { padding: 5px; border: 1px solid #ccc; font-size: 12px; white-space: nowrap; }
        .col-select { width: 100%; padding: 5px; border: 1px solid #000; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container" id="contentToPrint">
        <div class="header">
            <div class="logo-container">
                <img src="https://cdn.imgpile.com/f/ZMtwhK9_xl.png" alt="Logo" class="logo">
            </div>
            <div class="company-info">
                <div class="company-name">C√îNG TY TNHH TM DV K·∫æT GIAO PH√ÅT TRI·ªÇN QU·ªêC T·∫æ IDECO</div>
                <div class="document-title">BI√äN B·∫¢N NH·∫¨N H√ÄNG</div>
                <div class="document-code">M√£ s·ªë: BMI.06</div>
            </div>
            <div style="width: 100px;"></div>
        </div>

        <div id="connectionStatus" class="alert" style="display: none;">
            <span class="status-indicator"></span>
            <span id="statusText">ƒêang k·∫øt n·ªëi...</span>
        </div>

        <div class="compact-form-section">
            <div class="input-group">
                <div class="form-control" style="flex: 2;">
                    <label>T√™n nh√† cung c·∫•p</label>
                    <input type="text" id="supplierName" list="supplierList" placeholder="Nh·∫≠p t√™n NCC...">
                    <datalist id="supplierList"></datalist>
                </div>
                <div class="form-control">
                    <label>S·ªë H√≥a ƒë∆°n</label>
                    <input type="text" id="invoiceNumber">
                </div>
                <div class="form-control">
                    <label>S·ªë H·ª£p ƒë·ªìng</label>
                    <input type="text" id="contractNumber">
                </div>
            </div>
            
            <div class="input-group">
                <div class="form-control" style="flex: 2;">
                    <label>N∆°i nh·∫≠n h√†ng</label>
                    <input type="text" id="receivingPlace">
                </div>
                <div class="form-control">
                    <label>Ng√†y nh·∫≠n (dd/mm/yyyy)</label>
                    <input type="date" id="receivingDate">
                </div>
                <div class="form-control">
                    <label>Gi·ªù nh·∫≠n</label>
                    <input type="time" id="receivingTime">
                </div>
            </div>

            <div class="input-group">
                <div class="form-control" style="width: 100%;">
                    <label>K·∫øt qu·∫£ ki·ªÉm nghi·ªám</label>
                    <textarea id="inspectionResult" rows="1"></textarea>
                </div>
            </div>
        </div>

        <div style="margin-bottom: 15px;">
            <div style="font-weight: bold; margin-bottom: 5px; text-transform: uppercase; border-bottom: 1px solid #000; display: inline-block;">Danh m·ª•c thu·ªëc:</div>
            <table id="productTable">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>T√™n h√†ng h√≥a / Quy c√°ch</th>
                        <th style="width: 60px;">ƒêVT</th>
                        <th style="width: 80px;">S·ªë L√¥</th>
                        <th style="width: 80px;">H·∫°n SD</th>
                        <th style="width: 60px;">SL<br>Th·ª±c t·∫ø</th>
                        <th style="width: 50px;">Th·ª´a</th>
                        <th style="width: 50px;">Thi·∫øu</th>
                        <th style="width: 50px;">H·ªèng</th>
                        <th style="width: 90px;">T√¨nh tr·∫°ng</th>
                        <th>Ghi ch√∫</th>
                        <th class="no-print" style="width: 40px;">X√≥a</th>
                    </tr>
                </thead>
                <tbody id="productTableBody"></tbody>
            </table>
            <button type="button" id="addProductBtn" class="btn no-print" style="margin-top: 5px;">+ Th√™m d√≤ng</button>
        </div>

        <div class="receiving-info" style="border: 1px solid #000; padding: 10px; margin-bottom: 10px;">
            <div class="input-group">
                <div class="form-control">
                    <label>Giao nh·∫≠n v·∫≠n chuy·ªÉn</label>
                    <input type="text" id="deliveryTransport">
                </div>
                <div class="form-control">
                    <label>ƒêi·ªÅu ki·ªán thanh to√°n</label>
                    <input type="text" id="paymentCondition">
                </div>
            </div>
            <div class="input-group">
                <div class="form-control">
                    <label>C√°c y√™u c·∫ßu kh√°c</label>
                    <input type="text" id="otherRequirements">
                </div>
            </div>
        </div>

        <div class="signature-section">
            <div class="signature-box">
                <div class="signature-title">B·ªô Ph·∫≠n Kho/K·∫ø to√°n</div>
                <br><br><br>
                <input type="text" id="deptStaffName" class="signature-name" placeholder="(K√Ω, ghi r√µ h·ªç t√™n)">
            </div>
            <div class="signature-box">
                <div class="signature-title">Ng∆∞·ªùi l·∫≠p bi√™n b·∫£n</div>
                <br><br><br>
                <input type="text" id="preparerName" class="signature-name" placeholder="(K√Ω, ghi r√µ h·ªç t√™n)">
            </div>
            <div class="signature-box">
                <div class="signature-title">Ph·ª• tr√°ch chuy√™n m√¥n</div>
                <br><br><br>
                <input type="text" id="warehouseStaffName" class="signature-name" placeholder="(K√Ω, ghi r√µ h·ªç t√™n)">
            </div>
        </div>

        <div class="upload-section no-print">
            <strong>Nh·∫≠p d·ªØ li·ªáu:</strong>
            <div style="margin-top: 5px; display: flex; gap: 10px; align-items: center;">
                <input type="file" id="dataFile" accept=".xlsx,.xls">
                <span>HO·∫∂C</span>
                <button type="button" id="openPasteModalBtn" class="btn">üìã D√°n t·ª´ Excel & Soi chi·∫øu</button>
            </div>
            <div id="uploadMessage"></div>
        </div>

        <div class="utility-buttons no-print">
             <button type="button" class="btn" onclick="window.open('https://idecochupanh.netlify.app', '_blank')">üì∑ Camera AI</button>
             <button type="button" class="btn" onclick="window.open('https://erp-ideco.skyit.vn/#/app/dashboard/main', '_blank')">üè† ERP Home</button>
        </div>

        <div class="action-buttons no-print">
            <button type="button" id="saveBtn" class="btn" style="background: #333; color: white;">üíæ L∆∞u & T·∫°o PDF</button>
            <button type="button" id="exportExcelBtn" class="btn">üìä Excel</button>
            <button type="button" id="exportPdfBtn" class="btn">üìÑ PDF</button>
            <button type="button" id="printBtn" class="btn">üñ®Ô∏è In ngay</button>
            <button type="button" id="resetBtn" class="btn" style="border-color: red; color: red;">üîÑ L√†m m·ªõi</button>
        </div>
        
        <div class="saved-files-section no-print">
            <strong>File ƒë√£ l∆∞u:</strong>
            <div class="files-list" id="filesList"></div>
        </div>
    </div>

    <div id="pasteModal" class="modal no-print">
        <div class="modal-content">
            <span class="close-modal" id="closePasteModal" style="float:right; cursor:pointer; font-size:24px; font-weight:bold;">&times;</span>
            <h3 style="margin-top: 0;">D√°n d·ªØ li·ªáu t·ª´ Excel & Soi chi·∫øu c·ªôt</h3>
            <p style="font-size: 13px; color: #666; margin-bottom: 10px;">B∆∞·ªõc 1: Copy b·∫£ng t·ª´ Excel v√† d√°n v√†o √¥ b√™n d∆∞·ªõi.</p>
            <textarea id="pasteInput" style="width:100%; height:120px; border:1px solid #000; font-family: monospace; padding: 10px;" placeholder="D√°n d·ªØ li·ªáu v√†o ƒë√¢y (Ctrl + V)..."></textarea>
            
            <div id="previewContainer" style="display: none; margin-top: 15px; border-top: 1px solid #ccc; padding-top: 10px;">
                <h4 style="margin: 5px 0;">B∆∞·ªõc 2: Xem tr∆∞·ªõc & Ch·ªçn c·ªôt t∆∞∆°ng ·ª©ng</h4>
                <p style="font-size: 13px; color: red;">* Vui l√≤ng ch·ªçn ƒë√∫ng t√™n c·ªôt ·ªü d√≤ng ti√™u ƒë·ªÅ b√™n d∆∞·ªõi</p>
                <div style="overflow-x: auto; max-height: 300px;">
                    <table class="mapping-table" id="mappingTable"></table>
                </div>
                <div style="margin-top: 15px; text-align: right;">
                    <button type="button" id="processPasteBtn" class="btn" style="background: #333; color: white; padding: 10px 20px;">üì• X√ÅC NH·∫¨N NH·∫¨P D·ªÆ LI·ªÜU</button>
                </div>
            </div>
        </div>
    </div>

    <div id="pdfOptions" class="modal no-print">
        <div class="modal-content" style="width: 300px;">
            <h3>T√πy ch·ªçn PDF</h3>
            <label><input type="radio" name="pageOrientation" value="portrait" checked> Kh·ªï d·ªçc (A4)</label><br>
            <label><input type="radio" name="pageOrientation" value="landscape"> Kh·ªï ngang (A4)</label><br><br>
            <button id="confirmExportPdf" class="btn" style="background:#333; color:white;">Xu·∫•t file</button>
            <button id="cancelExportPdf" class="btn">H·ªßy</button>
        </div>
    </div>

    <script>
        // --- CONFIG & INIT ---
        const firebaseConfig = { apiKey: "AIzaSyCM_gZ1DEOtUwB0Ii-dm-6jIpxydoJU4-E", authDomain: "dulieuthuoc-d532e.firebaseapp.com", projectId: "dulieuthuoc-d532e", storageBucket: "dulieuthuoc-d532e.firebasestorage.app", messagingSenderId: "70002622120", appId: "1:70002622120:web:9676e1616a0774bae28c9d", measurementId: "G-LQ5P054T97" };
        let db, storage;
        try { firebase.initializeApp(firebaseConfig); db = firebase.firestore(); storage = firebase.storage(); } catch (e) { console.error(e); }

        function showMessage(msg, type) { 
            const el = document.getElementById('uploadMessage'); 
            el.innerHTML = `<div style="color:${type==='error'?'red':'green'}">${msg}</div>`; 
            setTimeout(() => el.innerHTML = '', 5000); 
        }
        
        function formatDateForInput(d) {
            if(!d) return '';
            // Gi·ªØ nguy√™n n·∫øu l√† dd/mm/yyyy ƒë·ªÉ hi·ªÉn th·ªã (logic mapping s·∫Ω x·ª≠ l√Ω sau) ho·∫∑c format chu·∫©n yyyy-mm-dd cho input date
            if(d.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) { 
                const p = d.split('/'); return `${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`; 
            }
            return d;
        }

        function toggleInputsForExport(isExporting) {
            const statusEl = document.getElementById('connectionStatus');
            if(statusEl) statusEl.style.display = isExporting ? 'none' : (db ? 'flex' : 'none');
            
            document.querySelectorAll('.print-substitution').forEach(e => e.remove());
            document.querySelectorAll('textarea, input, select').forEach(el => {
                if(['button','file','radio','checkbox','hidden'].includes(el.type)) return;
                if (isExporting) {
                    const div = document.createElement('div');
                    div.className = 'print-substitution';
                    div.style.textAlign = window.getComputedStyle(el).textAlign;
                    if (el.tagName === 'SELECT') div.textContent = el.options[el.selectedIndex]?.text || '';
                    else if (el.type === 'date' && el.value) {
                        const p = el.value.split('-');
                        div.textContent = `${p[2]}/${p[1]}/${p[0]}`;
                    } else { div.textContent = el.value; }
                    el.style.display = 'none';
                    el.parentNode.insertBefore(div, el);
                } else { el.style.display = ''; }
            });
        }

        window.onbeforeprint = () => toggleInputsForExport(true);
        window.onafterprint = () => toggleInputsForExport(false);

        document.addEventListener('DOMContentLoaded', function() {
            loadSuppliers(); loadDataFromFirebase(); loadSavedFiles();
            const now = new Date();
            document.getElementById('receivingDate').valueAsDate = now;
            document.getElementById('receivingTime').value = now.toTimeString().slice(0,5);

            document.getElementById('addProductBtn').onclick = () => addNewProductRow();
            document.getElementById('saveBtn').onclick = saveDataAndCreatePDF;
            document.getElementById('resetBtn').onclick = resetForm;
            document.getElementById('printBtn').onclick = () => window.print();
            
            const cs = document.getElementById('connectionStatus');
            if(db) db.enableNetwork().then(() => { cs.style.display = 'flex'; cs.innerHTML = '<span class="status-indicator" style="background:black"></span> K·∫øt n·ªëi OK'; }).catch(() => { cs.innerHTML = 'L·ªói m·∫°ng'; });
            
            // SETUP PASTE MODAL FULL T√çNH NƒÇNG
            setupPasteModal();
            
            document.getElementById('dataFile').onchange = handleExcelUpload;
            setupPdfExport();
            document.querySelectorAll('input, select, textarea').forEach(e => e.addEventListener('change', saveDataToFirebase));
        });

        // --- LOGIC PASTE & MAPPING (ƒê√£ s·ª≠a l·∫°i) ---
        function setupPasteModal() {
            const modal = document.getElementById('pasteModal');
            const pasteInput = document.getElementById('pasteInput');
            const previewContainer = document.getElementById('previewContainer');
            const mappingTable = document.getElementById('mappingTable');
            let parsedData = [];

            // M·ªü Modal
            document.getElementById('openPasteModalBtn').onclick = () => { 
                modal.style.display = 'flex'; 
                pasteInput.value = ''; 
                previewContainer.style.display = 'none'; 
                pasteInput.focus(); 
            };
            
            // ƒê√≥ng Modal
            document.getElementById('closePasteModal').onclick = () => { modal.style.display = 'none'; };
            window.onclick = (e) => { if (e.target == modal) modal.style.display = 'none'; };

            // Khi d√°n text v√†o
            pasteInput.addEventListener('input', function() {
                const text = this.value.trim();
                if (!text) { previewContainer.style.display = 'none'; return; }
                
                // Parse Text (T√°ch d√≤ng v√† tab)
                const rows = text.split(/\n/);
                parsedData = rows.map(row => row.split(/\t/));
                
                if (parsedData.length > 0) {
                    renderPreview(parsedData);
                    previewContainer.style.display = 'block';
                }
            });

            // V·∫Ω b·∫£ng xem tr∆∞·ªõc v·ªõi Dropdown ch·ªçn c·ªôt
            function renderPreview(data) {
                mappingTable.innerHTML = '';
                if (data.length === 0) return;

                const colCount = data[0].length;
                const thead = document.createElement('tr');
                
                // C√°c t√πy ch·ªçn mapping
                const options = [
                    {v:'skip',t:'-- B·ªè qua --'},
                    {v:'productName',t:'T√™n h√†ng h√≥a'},
                    {v:'unit',t:'ƒê∆°n v·ªã t√≠nh'},
                    {v:'lotNumber',t:'S·ªë L√¥'},
                    {v:'expiryDate',t:'H·∫°n D√πng'},
                    {v:'actualQuantity',t:'S·ªë l∆∞·ª£ng th·ª±c t·∫ø'},
                    {v:'note',t:'Ghi ch√∫'}
                ];

                // T·∫°o h√†ng Header ch·ª©a Dropdown
                for (let i = 0; i < colCount; i++) {
                    const th = document.createElement('th');
                    const select = document.createElement('select');
                    select.className = 'col-select';
                    select.dataset.colIndex = i;
                    
                    options.forEach(opt => { 
                        const option = document.createElement('option'); 
                        option.value = opt.v; 
                        option.text = opt.t; 
                        select.appendChild(option); 
                    });
                    
                    // T·ª± ƒë·ªông g·ª£i √Ω (Basic AI logic)
                    const firstVal = data[0][i] ? data[0][i].toLowerCase() : '';
                    if(firstVal.includes('t√™n')) select.value = 'productName';
                    else if(firstVal.includes('ƒëvt') || firstVal.includes('ƒë∆°n v·ªã')) select.value = 'unit';
                    else if(firstVal.includes('l√¥')) select.value = 'lotNumber';
                    else if(firstVal.includes('h·∫°n')) select.value = 'expiryDate';
                    else if(firstVal.includes('l∆∞·ª£ng')) select.value = 'actualQuantity';
                    else select.value = 'skip';

                    th.appendChild(select);
                    thead.appendChild(th);
                }
                mappingTable.appendChild(thead);

                // Hi·ªÉn th·ªã t·ªëi ƒëa 5 d√≤ng d·ªØ li·ªáu m·∫´u
                for (let i = 0; i < Math.min(data.length, 5); i++) {
                    const tr = document.createElement('tr');
                    data[i].forEach(cell => { 
                        const td = document.createElement('td'); 
                        td.textContent = cell; 
                        tr.appendChild(td); 
                    });
                    mappingTable.appendChild(tr);
                }
            }

            // X·ª≠ l√Ω khi b·∫•m n√∫t "X√°c nh·∫≠n nh·∫≠p d·ªØ li·ªáu"
            document.getElementById('processPasteBtn').addEventListener('click', function() {
                const selects = document.querySelectorAll('.col-select');
                const mappings = [];
                
                selects.forEach(sel => { 
                    if (sel.value !== 'skip') mappings.push({ index: parseInt(sel.dataset.colIndex), field: sel.value }); 
                });

                if (mappings.length === 0) { alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt c·ªôt d·ªØ li·ªáu (VD: T√™n h√†ng)!'); return; }

                let importedCount = 0;
                parsedData.forEach(row => {
                    if (row.length === 0 || (row.length === 1 && row[0].trim() === '')) return; // B·ªè d√≤ng tr·ªëng
                    
                    const productData = {};
                    let hasData = false;

                    mappings.forEach(map => { 
                        if (row[map.index] !== undefined) {
                            productData[map.field] = row[map.index].trim(); 
                            if(productData[map.field]) hasData = true;
                        }
                    });

                    // Ch·ªâ th√™m n·∫øu d√≤ng ƒë√≥ c√≥ d·ªØ li·ªáu
                    if (hasData) { 
                        addNewProductRow(productData); 
                        importedCount++; 
                    }
                });

                showMessage(`ƒê√£ nh·∫≠p th√†nh c√¥ng ${importedCount} d√≤ng!`, 'success');
                saveDataToFirebase();
                modal.style.display = 'none';
            });
        }

        // --- C√ÅC H√ÄM KH√ÅC (Reset, PDF, Excel...) ---
        function resetForm() {
            if(!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a h·∫øt d·ªØ li·ªáu v√† t·∫°o phi·∫øu m·ªõi?')) return;
            document.querySelectorAll('input, textarea').forEach(el => {
                if(el.type !== 'button' && el.type !== 'file' && el.type !== 'radio') el.value = '';
            });
            document.getElementById('productTableBody').innerHTML = '';
            productCount = 0;
            const now = new Date();
            document.getElementById('receivingDate').valueAsDate = now;
            document.getElementById('receivingTime').value = now.toTimeString().slice(0,5);
            document.getElementById('warehouseStaffName').value = 'Ph·∫°m Minh T√¢m';
            document.getElementById('receivingPlace').value = '003 Carlion 5 262/3 L≈©y B√°n B√≠ch - Ph∆∞·ªùng T√¢n Ph√∫ -Tp. H·ªì Ch√≠ Minh';
            saveDataToFirebase();
        }

        function setupPdfExport() {
            const modal = document.getElementById('pdfOptions');
            document.getElementById('exportPdfBtn').onclick = () => modal.style.display = 'flex';
            document.getElementById('cancelExportPdf').onclick = () => modal.style.display = 'none';
            document.getElementById('confirmExportPdf').onclick = () => {
                const ori = document.querySelector('input[name="pageOrientation"]:checked').value;
                toggleInputsForExport(true);
                document.querySelectorAll('.no-print').forEach(e => e.style.display = 'none');
                const element = document.getElementById('contentToPrint');
                html2canvas(element, { scale: 2, useCORS: true, windowWidth: element.scrollWidth, scrollY: -window.scrollY }).then(canvas => {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF({ orientation: ori, unit: 'mm', format: 'a4' });
                    const imgData = canvas.toDataURL('image/png');
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();
                    const imgProps = doc.getImageProperties(imgData);
                    const pdfHeight = (imgProps.height * pageWidth) / imgProps.width;
                    let heightLeft = pdfHeight, position = 0;
                    doc.addImage(imgData, 'PNG', 0, position, pageWidth, pdfHeight);
                    heightLeft -= pageHeight;
                    while (heightLeft >= 0) {
                        position = heightLeft - pdfHeight;
                        doc.addPage();
                        doc.addImage(imgData, 'PNG', 0, position, pageWidth, pdfHeight);
                        heightLeft -= pageHeight;
                    }
                    const fileName = `BienBan_${new Date().getTime()}.pdf`;
                    doc.save(fileName);
                    savePdfToDb(doc.output('blob'), fileName);
                    toggleInputsForExport(false);
                    document.querySelectorAll('.no-print').forEach(e => e.style.display = '');
                    modal.style.display = 'none';
                });
            };
        }

        let productCount = 0;
        function addNewProductRow(data = {}) {
            productCount++;
            const tr = document.createElement('tr');
            const name = data['T√™n H√†ng H√≥a'] || data['productName'] || '';
            tr.innerHTML = `
                <td>${productCount}</td>
                <td style="text-align:left;"><textarea name="productName" rows="1" style="width:100%; border:none; resize:none; outline:none;" placeholder="Nh·∫≠p t√™n h√†ng...">${name}</textarea></td>
                <td><input type="text" name="unit" value="${data['unit']||data['ƒê∆°n V·ªã']||'H·ªôp'}" style="text-align:center; border:none;"></td>
                <td><input type="text" name="lotNumber" value="${data['lotNumber']||data['S·ªë L√¥']||''}" style="text-align:center; border:none;"></td>
                <td><input type="date" name="expiryDate" value="${formatDateForInput(data['expiryDate']||data['H·∫°n D√πng']||'')}" style="border:none;"></td>
                <td><input type="number" name="actualQuantity" value="${data['actualQuantity']||data['S·ªë L∆∞·ª£ng']||''}" style="text-align:center; border:none;"></td>
                <td><input type="number" name="excess" value="${data['excess']||0}" style="text-align:center; border:none; width:40px;"></td>
                <td><input type="number" name="shortage" value="${data['shortage']||0}" style="text-align:center; border:none; width:40px;"></td>
                <td><input type="number" name="damaged" value="${data['damaged']||0}" style="text-align:center; border:none; width:40px;"></td>
                <td><select name="condition" style="border:none;"><option value="Nguy√™n v·∫πn">Nguy√™n v·∫πn</option><option value="H∆∞ h·ªèng">H∆∞ h·ªèng</option></select></td>
                <td><input type="text" name="note" value="${data['note']||''}" style="border:none;"></td>
                <td class="no-print"><button onclick="removeRow(this)" style="background:none;border:none;color:red;font-weight:bold;cursor:pointer;">X</button></td>
            `;
            if(data['condition']) tr.querySelector('select').value = data['condition'];
            document.getElementById('productTableBody').appendChild(tr);
        }

        window.removeRow = function(btn) {
            btn.closest('tr').remove();
            let i=0; document.querySelectorAll('#productTableBody tr').forEach(r => r.cells[0].textContent = ++i); productCount=i;
            saveDataToFirebase();
        }

        function collectData() {
            const products = [];
            document.querySelectorAll('#productTableBody tr').forEach(r => {
                products.push({
                    productName: r.querySelector('[name="productName"]').value,
                    unit: r.querySelector('[name="unit"]').value,
                    lotNumber: r.querySelector('[name="lotNumber"]').value,
                    expiryDate: r.querySelector('[name="expiryDate"]').value,
                    actualQuantity: r.querySelector('[name="actualQuantity"]').value,
                    excess: r.querySelector('[name="excess"]').value,
                    shortage: r.querySelector('[name="shortage"]').value,
                    damaged: r.querySelector('[name="damaged"]').value,
                    condition: r.querySelector('[name="condition"]').value,
                    note: r.querySelector('[name="note"]').value
                });
            });
            return {
                info: {
                    supplier: document.getElementById('supplierName').value,
                    invoice: document.getElementById('invoiceNumber').value,
                    contract: document.getElementById('contractNumber').value,
                    place: document.getElementById('receivingPlace').value,
                    date: document.getElementById('receivingDate').value,
                    time: document.getElementById('receivingTime').value,
                    inspection: document.getElementById('inspectionResult').value,
                    transport: document.getElementById('deliveryTransport').value,
                    payment: document.getElementById('paymentCondition').value,
                    other: document.getElementById('otherRequirements').value,
                    deptStaff: document.getElementById('deptStaffName').value,
                    preparer: document.getElementById('preparerName').value,
                    warehouseStaff: document.getElementById('warehouseStaffName').value
                }, products
            };
        }

        function saveDataToFirebase() {
            if(db) db.collection('deliveryRecords').doc('current').set(collectData()).catch(console.error);
        }

        function loadDataFromFirebase() {
            if(!db) return;
            db.collection('deliveryRecords').doc('current').onSnapshot(doc => {
                if(doc.exists) {
                    const d = doc.data(); const i = d.info || {};
                    document.getElementById('supplierName').value = i.supplier||'';
                    document.getElementById('invoiceNumber').value = i.invoice||'';
                    document.getElementById('contractNumber').value = i.contract||'';
                    document.getElementById('receivingPlace').value = i.place||'';
                    document.getElementById('receivingDate').value = i.date||'';
                    document.getElementById('receivingTime').value = i.time||'';
                    document.getElementById('inspectionResult').value = i.inspection||'';
                    document.getElementById('deliveryTransport').value = i.transport||'';
                    document.getElementById('paymentCondition').value = i.payment||'';
                    document.getElementById('otherRequirements').value = i.other||'';
                    document.getElementById('deptStaffName').value = i.deptStaff||'';
                    document.getElementById('preparerName').value = i.preparer||'';
                    document.getElementById('warehouseStaffName').value = i.warehouseStaff||'Ph·∫°m Minh T√¢m';
                    const tb = document.getElementById('productTableBody'); tb.innerHTML = ''; productCount=0;
                    (d.products||[]).forEach(p => addNewProductRow(p));
                }
            });
        }
        
        function saveDataAndCreatePDF() {
            saveDataToFirebase();
            document.getElementById('exportPdfBtn').click();
        }

        function savePdfToDb(blob, name) {
            if(storage && db) {
                storage.ref(`pdfs/${name}`).put(blob).then(s => s.ref.getDownloadURL())
                .then(url => db.collection('savedPdfs').add({ fileName: name, downloadURL: url, createdAt: firebase.firestore.FieldValue.serverTimestamp() }))
                .then(() => showMessage('ƒê√£ l∆∞u PDF v√†o h·ªá th·ªëng', 'success'));
            }
        }
        
        function loadSavedFiles() {
            if(!db) return;
            db.collection('savedPdfs').orderBy('createdAt', 'desc').limit(5).onSnapshot(s => {
                const l = document.getElementById('filesList'); l.innerHTML = '';
                s.forEach(d => {
                    const dd = d.data();
                    l.innerHTML += `<div style="display:flex;justify-content:space-between;border-bottom:1px solid #eee;padding:5px;"><span>${dd.fileName}</span><a href="${dd.downloadURL}" target="_blank">T·∫£i</a></div>`;
                });
            });
        }

        function loadSuppliers() {
            if(db) db.collection('suppliers').get().then(q => {
                const dl = document.getElementById('supplierList'); dl.innerHTML = '';
                q.forEach(d => { const o = document.createElement('option'); o.value = d.data().name; dl.appendChild(o); });
            });
        }

        function handleExcelUpload(e) {
            const f = e.target.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = (evt) => {
                try {
                    const wb = XLSX.read(new Uint8Array(evt.target.result), {type:'array'});
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(ws, {header:1});
                    let hIdx = -1;
                    for(let i=0;i<json.length;i++) if(JSON.stringify(json[i]).includes('T√™n')) { hIdx=i; break; }
                    if(hIdx>-1) {
                         document.getElementById('productTableBody').innerHTML=''; productCount=0;
                         const headers = json[hIdx];
                         for(let i=hIdx+1; i<json.length; i++) {
                             const row = json[i]; if(!row || !row.length) continue;
                             const d = {};
                             headers.forEach((h, idx) => { if(h && row[idx]) d[h] = row[idx]; });
                             addNewProductRow(d);
                         }
                    }
                } catch(ex) { alert('L·ªói ƒë·ªçc file'); }
            };
            r.readAsArrayBuffer(f);
        }
        
        document.getElementById('exportExcelBtn').onclick = () => {
            const wb = XLSX.utils.book_new();
            const data = [['BI√äN B·∫¢N NH·∫¨N H√ÄNG'],
                          ['Nh√† cung c·∫•p:', document.getElementById('supplierName').value],
                          ['STT','T√™n h√†ng','ƒêVT','S·ªë l√¥','H·∫°n d√πng','SL Th·ª±c t·∫ø','T√¨nh tr·∫°ng','Ghi ch√∫']];
            document.querySelectorAll('#productTableBody tr').forEach(r => {
                const i = r.querySelectorAll('input,textarea,select');
                data.push([r.cells[0].innerText, i[0].value, i[1].value, i[2].value, i[3].value, i[4].value, i[8].value, i[9].value]);
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(data), 'Sheet1');
            XLSX.writeFile(wb, 'BienBan.xlsx');
        };
    </script>
</body>
</html>
