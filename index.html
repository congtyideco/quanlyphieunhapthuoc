<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin Th√¥ng B√°o</title>
    <style>
        :root {
            --primary-color: #667eea;
            --primary-gradient: linear-gradient(135deg, #667eea, #764ba2);
            --control-gradient: linear-gradient(135deg, #ff9966, #ff5e62); /* M√†u cam cho n√∫t ƒëi·ªÅu khi·ªÉn */
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-color: #333;
            --input-border: #ddd;
            --spacing-base: 16px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            color: var(--text-color);
            -webkit-tap-highlight-color: transparent;
        }

        /* Header */
        .app-header {
            background: var(--primary-gradient);
            color: white;
            padding: var(--spacing-base);
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .app-header h1 { margin: 0; font-size: 18px; font-weight: 600; }

        .container {
            padding: var(--spacing-base);
            padding-bottom: 120px; /* Ch·ª´a ch·ªó cho footer */
            max-width: 600px;
            margin: 0 auto;
        }

        /* Card Styles */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: var(--spacing-base);
            margin-bottom: var(--spacing-base);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        h2 {
            font-size: 16px; margin-top: 0; color: #555;
            border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 12px;
        }

        label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px; color: #444; }

        /* Inputs */
        textarea, input[type="text"] {
            width: 100%; padding: 12px; border: 1px solid var(--input-border);
            border-radius: 8px; box-sizing: border-box; font-size: 16px; 
            background-color: #fafafa; transition: border-color 0.3s;
        }
        textarea:focus, input[type="text"]:focus { outline: none; border-color: var(--primary-color); background-color: #fff; }

        /* Textarea Resize Logic */
        .textarea-wrapper { position: relative; display: flex; flex-direction: column; }
        textarea {
            height: 120px; min-height: 80px; resize: vertical;
            border-bottom-left-radius: 0; border-bottom-right-radius: 0; border-bottom: none;
        }
        .resize-handle {
            height: 24px; background-color: #e9ecef;
            border: 1px solid var(--input-border); border-top: 1px solid #ddd;
            border-bottom-left-radius: 8px; border-bottom-right-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            cursor: ns-resize; touch-action: none; color: #888;
        }
        .resize-handle::after { content: ""; width: 40px; height: 4px; border-top: 2px solid #bbb; border-bottom: 2px solid #bbb; }

        /* N√∫t X√≥a */
        .btn-clear {
            margin-top: 10px; background-color: #fff0f0; color: #d63031;
            border: 1px solid #fab1a0; padding: 8px 15px; border-radius: 6px;
            font-size: 14px; font-weight: 600; cursor: pointer;
        }

        /* N√∫t ƒêi·ªÅu Khi·ªÉn (Trigger) M·ªöI */
        .btn-trigger {
            width: 100%; padding: 15px;
            background: var(--control-gradient);
            color: white; border: none; border-radius: 8px;
            font-size: 16px; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 6px rgba(255, 94, 98, 0.25);
            display: flex; align-items: center; justify-content: center; gap: 8px;
            animation: pulse 2s infinite;
        }
        .btn-trigger:active { transform: scale(0.98); opacity: 0.9; }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 94, 98, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 94, 98, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 94, 98, 0); }
        }

        /* Schedule Grid */
        .day-group { margin-bottom: 15px; }
        .day-label { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .day-name { font-weight: bold; color: var(--primary-color); }
        .day-id { font-size: 12px; color: #999; background: #eee; padding: 2px 6px; border-radius: 4px; }

        /* Sticky Footer */
        .sticky-footer {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: white; padding: 15px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 100;
            display: flex; flex-direction: column; gap: 10px;
        }

        .btn-save {
            width: 100%; padding: 14px; background: var(--primary-gradient);
            color: white; border: none; border-radius: 8px;
            font-size: 16px; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 6px rgba(102, 126, 234, 0.25);
        }
        
        #status { text-align: center; font-size: 13px; font-weight: 500; }
        .loading { color: #666; } .success { color: #28a745; } .error { color: #dc3545; }

        @media (min-width: 600px) {
            .schedule-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        }
    </style>
</head>
<body>

    <header class="app-header">
        <h1>Admin Th√¥ng B√°o</h1>
    </header>

    <div class="container">
        
        <div class="card" style="border: 2px solid #ff9966;">
            <h2 style="color: #d35400; border-bottom-color: #ffccbc;">ƒêi·ªÅu Khi·ªÉn</h2>
            <p style="font-size: 13px; color: #666; margin-bottom: 15px;">
                B·∫•m n√∫t d∆∞·ªõi ƒë√¢y ƒë·ªÉ Popup xu·∫•t hi·ªán ngay l·∫≠p t·ª©c tr√™n m√†n h√¨nh ng∆∞·ªùi xem (b·∫•t k·ªÉ th·ªùi gian).
            </p>
            <button id="trigger-button" class="btn-trigger">
                üîî B·∫ÆN TH√îNG B√ÅO NGAY
            </button>
        </div>

        <div class="card">
            <label for="message-input">N·ªôi dung Popup:</label>
            <div class="textarea-wrapper">
                <textarea id="message-input" placeholder="Nh·∫≠p l·ªùi nh·∫Øn..."></textarea>
                <div id="resize-handle" class="resize-handle" title="K√©o ƒë·ªÉ ch·ªânh k√≠ch th∆∞·ªõc"></div>
            </div>
            <button id="clear-button" class="btn-clear">üóëÔ∏è X√≥a n·ªôi dung ƒë·ªÉ vi·∫øt l·∫°i</button>
        </div>

        <div class="card">
            <h2>L·∫≠p L·ªãch T·ª± ƒê·ªông</h2>
            <div class="note" style="font-size:13px; color:#666; background:#eef2ff; padding:10px; border-radius:8px; margin-bottom:15px;">
                Nh·∫≠p gi·ªù (VD: <b>09:00, 14:30</b>). ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng mu·ªën hi·ªán.
            </div>

            <div class="schedule-grid">
                <div class="day-group"><div class="day-label"><span class="day-name">Th·ª© Hai</span><span class="day-id">T2</span></div><input type="text" id="day-1" placeholder="09:00"></div>
                <div class="day-group"><div class="day-label"><span class="day-name">Th·ª© Ba</span><span class="day-id">T3</span></div><input type="text" id="day-2" placeholder="09:00"></div>
                <div class="day-group"><div class="day-label"><span class="day-name">Th·ª© T∆∞</span><span class="day-id">T4</span></div><input type="text" id="day-3" placeholder="09:00"></div>
                <div class="day-group"><div class="day-label"><span class="day-name">Th·ª© NƒÉm</span><span class="day-id">T5</span></div><input type="text" id="day-4" placeholder="09:00"></div>
                <div class="day-group"><div class="day-label"><span class="day-name">Th·ª© S√°u</span><span class="day-id">T6</span></div><input type="text" id="day-5" placeholder="09:00"></div>
                <div class="day-group"><div class="day-label"><span class="day-name">Th·ª© B·∫£y</span><span class="day-id">T7</span></div><input type="text" id="day-6" placeholder="09:00"></div>
                <div class="day-group"><div class="day-label"><span class="day-name">Ch·ªß Nh·∫≠t</span><span class="day-id">CN</span></div><input type="text" id="day-0" placeholder="09:00"></div>
            </div>
        </div>
    </div>

    <div class="sticky-footer">
        <div id="status" class="loading">ƒêang k·∫øt n·ªëi Firebase...</div>
        <button id="save-button" class="btn-save">L∆ØU C·∫§U H√åNH L·ªäCH</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        // Import th√™m h√†m 'update' ƒë·ªÉ ch·ªâ c·∫≠p nh·∫≠t 1 tr∆∞·ªùng d·ªØ li·ªáu
        import { getDatabase, ref, onValue, set, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        // --- CODE X·ª¨ L√ù N√öT K√çCH HO·∫†T NGAY (M·ªöI) ---
        const triggerButton = document.getElementById('trigger-button');
        
        triggerButton.addEventListener('click', () => {
            if(confirm("B·∫°n mu·ªën hi·ªÉn th·ªã Popup n√†y ngay l·∫≠p t·ª©c cho ng∆∞·ªùi xem?")) {
                const now = new Date();
                const timeString = now.toLocaleTimeString('vi-VN');
                
                // C·∫≠p nh·∫≠t tr∆∞·ªùng 'lastTriggered' l√™n Firebase
                // B√™n Client c·∫ßn l·∫Øng nghe tr∆∞·ªùng n√†y thay ƒë·ªïi ƒë·ªÉ hi·ªÉn th·ªã
                update(scheduleRef, {
                    forceShow: Date.now(), // G·ª≠i timestamp hi·ªán t·∫°i
                    triggerMessage: "Admin k√≠ch ho·∫°t l√∫c " + timeString
                })
                .then(() => {
                    alert("ƒê√£ g·ª≠i l·ªánh hi·ªÉn th·ªã th√†nh c√¥ng!");
                })
                .catch((err) => {
                    alert("L·ªói: " + err.message);
                });
            }
        });
        // --- H·∫æT CODE M·ªöI ---

        // --- C√ÅC CH·ª®C NƒÇNG C≈® (GI·ªÆ NGUY√äN) ---
        const clearButton = document.getElementById('clear-button');
        clearButton.addEventListener('click', () => {
            if (confirm("X√≥a h·∫øt n·ªôi dung vƒÉn b·∫£n?")) {
                document.getElementById('message-input').value = "";
                document.getElementById('message-input').focus();
            }
        });

        // Resize Logic
        const textarea = document.getElementById('message-input');
        const resizeHandle = document.getElementById('resize-handle');
        let isResizing = false;
        let lastDownY = 0;

        resizeHandle.addEventListener('mousedown', (e) => { isResizing = true; lastDownY = e.clientY; document.body.style.cursor = 'ns-resize'; e.preventDefault(); });
        resizeHandle.addEventListener('touchstart', (e) => { isResizing = true; lastDownY = e.touches[0].clientY; e.preventDefault(); }, { passive: false });
        
        const handleMove = (clientY) => {
            if (!isResizing) return;
            const offset = clientY - lastDownY;
            const newHeight = textarea.offsetHeight + offset;
            if (newHeight > 60) { textarea.style.height = newHeight + 'px'; lastDownY = clientY; }
        };
        const handleUp = () => { isResizing = false; document.body.style.cursor = 'default'; };

        document.addEventListener('mousemove', (e) => handleMove(e.clientY));
        document.addEventListener('mouseup', handleUp);
        document.addEventListener('touchmove', (e) => { if(isResizing) handleMove(e.touches[0].clientY); }, { passive: false });
        document.addEventListener('touchend', handleUp);


        // --- FIREBASE LOGIC ---
        const firebaseConfig = {
            apiKey: "AIzaSyCaEzd8OMJ553ETba-M_pxWSe2bDX9fh_I", 
            authDomain: "ideco-f82d4.firebaseapp.com",
            databaseURL: "https://ideco-f82d4-default-rtdb.firebaseio.com",
            projectId: "ideco-f82d4",
            storageBucket: "ideco-f82d4.appspot.com",
            messagingSenderId: "614324382815",
            appId: "1:614324382815:web:234ed4873b7156d80fffea"
        };

        const app = initializeApp(firebaseConfig, 'ThongBaoAdminMobileControl'); 
        const database = getDatabase(app);
        const scheduleRef = ref(database, 'scheduleConfig');

        const messageInput = document.getElementById('message-input');
        const saveButton = document.getElementById('save-button');
        const statusDiv = document.getElementById('status');
        
        const dayInputs = {
            0: document.getElementById('day-0'),
            1: document.getElementById('day-1'),
            2: document.getElementById('day-2'),
            3: document.getElementById('day-3'),
            4: document.getElementById('day-4'),
            5: document.getElementById('day-5'),
            6: document.getElementById('day-6')
        };

        // Load data
        onValue(scheduleRef, (snapshot) => {
            const config = snapshot.val();
            if (config) {
                messageInput.value = config.message || '';
                if (config.schedule) {
                    for (let dayKey in dayInputs) {
                        const timesArray = config.schedule[dayKey] || [];
                        dayInputs[dayKey].value = timesArray.join(', ');
                    }
                }
            }
            statusDiv.textContent = 'ƒê√£ k·∫øt n·ªëi d·ªØ li·ªáu.';
            statusDiv.className = 'success';
        });

        // Save Config
        saveButton.addEventListener('click', () => {
            saveButton.textContent = 'ƒêANG L∆ØU...';
            saveButton.disabled = true;
            statusDiv.textContent = 'ƒêang l∆∞u c·∫•u h√¨nh...';
            statusDiv.className = 'loading';

            const newConfig = {
                message: messageInput.value,
                schedule: {} 
            };

            for (let dayKey in dayInputs) {
                const inputString = dayInputs[dayKey].value; 
                const timesArray = inputString.split(',').map(t => t.trim()).filter(t => t.length > 0); 
                if (timesArray.length > 0) newConfig.schedule[dayKey] = timesArray;
            }

            // D√πng update ƒë·ªÉ kh√¥ng b·ªã m·∫•t tr∆∞·ªùng 'forceShow' n·∫øu n√≥ ƒëang t·ªìn t·∫°i
            update(scheduleRef, newConfig)
                .then(() => {
                    statusDiv.textContent = 'L∆∞u th√†nh c√¥ng!';
                    statusDiv.className = 'success';
                    setTimeout(() => { saveButton.textContent = 'L∆ØU C·∫§U H√åNH L·ªäCH'; saveButton.disabled = false; }, 1000);
                })
                .catch((error) => {
                    statusDiv.textContent = 'L·ªói: ' + error.message;
                    statusDiv.className = 'error';
                    saveButton.disabled = false;
                });
        });
    </script>
</body>
</html>
